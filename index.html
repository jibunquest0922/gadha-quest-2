<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GADHA QUEST</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@700;800&family=DotGothic16&display=swap" rel="stylesheet">
    <style>
        :root {
            --main-bg-color: #EFFBFA; 
            --container-border-color: #4FD1C5; 
            --container-shadow-color: #38B2AC; 
            --header-text-color: #2C7A7B; 
            --header-shadow-color: #A7F3E8; 
            --header-dot-shadow1: #286869; 
            --header-dot-shadow2: #66C5BC; 
            --nav-active-bg: #319795;
            --nav-active-border: #2C7A7B;
            --nav-inactive-bg: #718096; 
            --nav-inactive-border: #4A5568;
            --card-border-color: #63B3ED; 
            --card-shadow-color: #4299E1;
            --card-title-color: #2B6CB0;
            --status-bar-bg: #D6F5FE; 
            --status-bar-border: #63B3ED;
            --accent-warm-color: #F6AD55; 
            --accent-warm-dark-color: #DD6B20;
            --accent-green-color: #48BB78;
            --accent-green-dark-color: #38A169;
            --text-dark-blue: #1A202C; 
            --highlight-bg: #FEEBC8;
            --highlight-text: #9C4221;
            --font-main: 'M PLUS Rounded 1c', sans-serif;
            --font-pixel: 'DotGothic16', sans-serif;
            --diary-evaluation-bg: #FFFACD; 
            --diary-evaluation-border: #FADFAD; 
            --caretchi-hint-bg: #FFF9EB; 
            --caretchi-hint-border: #FBD38D;
        }
        body {
            font-family: var(--font-main);
            font-weight: 700;
            background-color: var(--main-bg-color);
            color: var(--text-dark-blue);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            overflow-x: hidden;
        }
        .container {
            background-color: #FFFFFF;
            border-radius: 24px;
            border: 4px solid var(--container-border-color);
            box-shadow: 0 12px 28px rgba(79, 209, 197, 0.25), 8px 8px 0px var(--container-shadow-color);
            padding:clamp(1.2rem, 4vw, 1.8rem);
            width: 100%;
            max-width: 800px;
            margin-top: 0;
        }
        .pixel-font { font-family: var(--font-pixel); }
        .header-title {
            font-family: var(--font-main); 
            font-weight: 800; 
            color: var(--header-text-color);
            text-shadow: 
                3px 3px 0px var(--header-dot-shadow1), 
                1px 1px 0px var(--header-dot-shadow2),
                -1px -1px 0px var(--header-dot-shadow2),
                1px -1px 0px var(--header-dot-shadow2),
                -1px 1px 0px var(--header-dot-shadow2),
                0 0 12px rgba(118, 210, 201, 0.6);
            font-size: clamp(2.4rem, 9vw, 3.5rem); 
            margin-bottom: 1.5rem; 
            text-align: center;
            letter-spacing: -1.5px; 
            line-height: 1.1;
        }
        .navigation-header {
            width: 100%;
            max-width: 800px;
            background-color: var(--status-bar-bg);
            border-bottom: 3px solid var(--status-bar-border);
            padding: 0.6rem 0.2rem;
            display: flex;
            justify-content: space-around;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
            z-index: 100;
            border-radius: 12px 12px 0 0;
            margin-bottom: 1.2rem;
        }
        .nav-button {
            font-family: var(--font-pixel);
            background-color: var(--nav-inactive-bg); color: white;
            border: 2px solid var(--nav-inactive-border);
            box-shadow: 3px 3px 0px var(--nav-inactive-border);
            padding: 0.6rem 0.4rem;
            border-radius: 10px;
            text-align: center;
            font-size: 0.75rem;
            flex-grow: 1; margin: 0 3px;
            max-width: 19%;
            white-space: nowrap;
            overflow: hidden; text-overflow: ellipsis;
            font-weight: 700;
            transition: all 0.15s ease-in-out;
        }
        .nav-button:hover {
            transform: translateY(-2px);
            box-shadow: 4px 5px 0px var(--nav-inactive-border);
        }
        .nav-button.active {
            background-color: var(--nav-active-bg);
            border-color: var(--nav-active-border);
            box-shadow: 2px 2px 0px var(--nav-active-border);
            transform: translateY(1px);
        }
        .screen { display: none; }
        .screen.active { display: block; }

        .pq-card {
            background-color: #FFF;
            border: 3px solid var(--card-border-color);
            border-radius: 16px; 
            padding: 1.3rem; 
            margin-bottom: 1.3rem;
            box-shadow: 7px 7px 0px var(--card-shadow-color); 
        }
        .pq-card-title {
            font-family: var(--font-pixel);
            font-size: 1.4rem; 
            color: var(--card-title-color);
            margin-bottom: 0.7rem;
            border-bottom: 3px dashed var(--card-border-color); 
            padding-bottom: 0.5rem;
            font-weight: 700;
        }
        .status-bar {
            display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap;
            background-color: var(--status-bar-bg); padding: 0.7rem; border-radius: 16px; 
            margin-bottom: 1.3rem; border: 3px solid var(--status-bar-border);
            box-shadow: inset 0 3px 6px rgba(0,0,0,0.1), 5px 5px 0 var(--status-bar-border); 
        }
        .status-item { text-align: center; margin: 0.3rem 0.6rem; }
        .status-item .label { font-family: var(--font-pixel); font-size: 0.9rem; color: var(--card-title-color); font-weight: 700;}
        .status-item .value { font-size: 1.3rem; font-weight: 700; color: var(--header-text-color); }
        .avatar-container {
            width: 70px; height: 70px; background-color: var(--accent-warm-color); 
            border-radius: 20px; display: flex; justify-content: center; align-items: center;
            box-shadow: 5px 5px 0px var(--accent-warm-dark-color);
            border: 3px solid var(--accent-warm-dark-color);
        }
        .avatar { font-size: 2.5rem; }

        textarea, input[type="text"], select {
            width: 100%; padding: 0.8rem; border: 3px solid var(--card-border-color);
            border-radius: 12px; margin-bottom: 0.9rem; box-sizing: border-box;
            background-color: #F8FAFC;
            font-size: 1rem; font-weight: 700;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.06);
        }
        textarea:focus, input[type="text"]:focus, select:focus {
            border-color: var(--accent-warm-color);
            outline: none;
            box-shadow: inset 2px 2px 5px rgba(0,0,0,0.06), 0 0 0 3px var(--accent-warm-color); 
        }

        .pq-button {
            font-family: var(--font-pixel); color: #FFF; padding: 14px 20px;
            border-radius: 12px; text-transform: uppercase; font-weight: 700;
            cursor: pointer; transition: all 0.15s ease-in-out; margin: 7px;
            font-size: 0.95rem;
            letter-spacing: 0.8px; 
            text-shadow: 1px 1px 0px rgba(0,0,0,0.2); 
        }
        .pq-button:hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: var(--accent-warm-dark-color) 0px 8px 0px 0px; 
        }
        .pq-button:active { transform: translate(3px, 3px); box-shadow: 1px 1px 0px var(--nav-inactive-border) !important; } 

        .pq-button.primary {
            background-color: var(--nav-active-bg); border: 3px solid var(--nav-active-border);
            box-shadow: 5px 5px 0px var(--nav-active-border);
        }
         .pq-button.primary:hover { box-shadow: var(--nav-active-border) 0px 8px 0px 0px; }


        .pq-button.accent {
            background-color: var(--accent-warm-color); border: 3px solid var(--accent-warm-dark-color);
            box-shadow: 5px 5px 0px var(--accent-warm-dark-color);
        }
        .pq-button.accent:hover { box-shadow: var(--accent-warm-dark-color) 0px 8px 0px 0px; }

        .pq-button.green {
            background-color: var(--accent-green-color); border: 3px solid var(--accent-green-dark-color);
            box-shadow: 5px 5px 0px var(--accent-green-dark-color);
        }
        .pq-button.green:hover { box-shadow: var(--accent-green-dark-color) 0px 8px 0px 0px; }


        .ai-feedback, .diary-evaluation, .caretchi-advice, .action-goal-hint { 
            background-color: var(--diary-evaluation-bg); 
            border: 3px dashed var(--diary-evaluation-border); 
            border-radius: 16px; padding: 1.3rem; margin-top: 1.3rem;
            box-shadow: 0 4px 6px rgba(250, 223, 173, 0.3); 
        }
        .ai-feedback h3, .diary-evaluation h3, .caretchi-advice h3, .action-goal-hint h3 { 
            font-family: var(--font-pixel); 
            color: var(--accent-warm-dark-color); 
            margin-top: 0; font-size: 1.3rem; font-weight: 700;
        }
        .ai-feedback p, .diary-evaluation p, .caretchi-advice p, .action-goal-hint p, .diary-evaluation ul li { 
            color: #B7791F; line-height: 1.7; font-size: 1rem; font-weight: 700;
        }
        .caretchi-advice { 
            padding: 0.8rem; margin-top: 0.5rem; margin-bottom: 1rem;
            text-align: center; font-size: 0.95rem;
        }
        .action-goal-hint { 
            padding: 1rem; margin-top: 0.8rem;
            font-size: 0.9rem;
            background-color: var(--caretchi-hint-bg);
            border-color: var(--caretchi-hint-border);
        }
        .action-goal-hint h3 { font-size: 1.1rem; margin-bottom: 0.5rem;}
        .action-goal-hint ul { list-style-type: 'ğŸ‘‰'; padding-left: 1.5rem; } 
        .action-goal-hint li { margin-bottom: 0.3rem; }

        .highlight {
            background-color: var(--highlight-bg); padding: 0.2em 0.5em;
            border-radius: 6px; font-weight: 700; color: var(--highlight-text);
            box-shadow: 1px 1px 3px rgba(0,0,0,0.15);
        }
        .small-text { font-size: 0.95rem; font-weight: 700;}
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: var(--main-bg-color); margin: 7% auto; padding: 30px;
            border: 6px solid var(--container-shadow-color); border-radius: 20px;
            width: 90%; max-width: 750px; box-shadow: 12px 12px 0px var(--header-text-color);
            position: relative; max-height: 85vh; overflow-y: auto;
        }
        .modal-title { font-family: var(--font-pixel); font-size: 1.6rem; color: var(--header-text-color); margin-bottom: 15px; font-weight: 700;}
        .modal-body p { margin-bottom: 1rem !important; line-height: 1.75; font-size: 1.05rem; } 
        .close-button {
            color: var(--accent-warm-dark-color); position: absolute; top: 10px; right: 20px;
            font-size: 32px; font-weight: bold; cursor: pointer; text-shadow: 1px 1px #FFF5EB;
        }
        .chat-bubble {
            padding: 0.7rem 1rem; border-radius: 14px;
            margin-bottom: 0.7rem; max-width: 85%; font-size: 1rem; font-weight: 700;
            box-shadow: 3px 3px 5px rgba(0,0,0,0.12);
        }
        .chat-bubble.user {
            background-color: var(--accent-warm-color); color: white;
            margin-left: auto; border-bottom-right-radius: 0;
        }
        .chat-bubble.ai {
            background-color: var(--status-bar-bg); color: var(--text-dark-blue);
            margin-right: auto; border-bottom-left-radius: 0;
        }
        #diaryLogListContainer { max-height: 350px; overflow-y: auto; padding-right: 10px;}
        .theory-section-summary { font-size: 0.95rem; color: #4A5568; margin-bottom: 0.7rem; font-weight: 500;}
        .theory-section {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            background-color: #F0FFFFA0; 
        }
        .theory-section:hover {
            transform: translateY(-4px) scale(1.01); 
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        @media (max-width: 480px) { 
            .nav-button { font-size: 0.7rem; padding: 0.5rem 0.2rem; max-width: 18%;}
            .header-title {font-size: 2rem; letter-spacing: -1px;}
            .pq-button { padding: 10px 12px; font-size: 0.85rem;}
            .modal-content {width: 95%; padding: 20px;}
            .pq-card { padding: 1rem; }
            .status-item .label { font-size: 0.75rem;}
            .status-item .value { font-size: 1.1rem;}
        }
    </style>
</head>
<body>
    <h1 class="header-title">GADHA QUEST</h1>
    <div class="navigation-header">
        <button class="nav-button active" onclick="navigateTo('homeScreen')">ãƒ›ãƒ¼ãƒ </button>
        <button class="nav-button" onclick="navigateTo('libraryScreen')">å›³æ›¸é¤¨</button>
        <button class="nav-button" onclick="navigateTo('diaryScreen')">å®Ÿè·µæ—¥è¨˜</button>
        <button class="nav-button" onclick="navigateTo('customInfoScreen')">å°‚ç”¨æƒ…å ±</button>
        <button class="nav-button" onclick="navigateTo('aiSupportScreen')">AIã‚µãƒãƒ¼ãƒˆ</button>
    </div>

    <div class="container">
        <div id="loadingIndicator" class="fixed inset-0 bg-gray-700 bg-opacity-80 flex items-center justify-center z-50" style="display: none;">
            <div class="pixel-font text-white text-2xl p-6 bg-teal-600 rounded-xl shadow-2xl">ã‚±ã‚¢ã£ã¡ãŒæº–å‚™ä¸­...</div>
        </div>

        <div id="homeScreen" class="screen active">
            <h2 class="pixel-font text-2xl text-center mb-2 text-green-600 font-bold">ä»Šæ—¥ã®å†’é™ºã‚¹ãƒ†ãƒƒãƒ—</h2>
            <div id="caretchiHomeAdvice" class="caretchi-advice mb-4">ã‚±ã‚¢ã£ã¡ã€Œä»Šæ—¥ã®ç›®æ¨™ã€ä¸€ç·’ã«é ‘å¼µã‚ã†ã­ï¼ã€</div>
            <div class="pq-card">
                <h3 class="pq-card-title">ä»Šæ—¥ã®ç›®æ¨™ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h3>
                <p id="todayActionGoal" class="text-gray-800 text-base font-bold">ã‚±ã‚¢ã£ã¡ãŒã‚ãªãŸã®æ—¥è¨˜ã‹ã‚‰ç›®æ¨™ã‚’è¨­å®šã—ã¾ã™...</p>
                <div id="todayActionGoalHint" class="action-goal-hint" style="display: none;">
                    <h3 class="pixel-font">ã‚±ã‚¢ã£ã¡ã®ãƒ’ãƒ³ãƒˆ</h3>
                    <ul id="actionGoalHintList" class="text-sm"></ul>
                </div>
                <button class="pq-button primary text-xs mt-2" onclick="toggleActionGoalHint()">ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹/éš ã™</button>
            </div>
            <div class="status-bar">
                <div class="avatar-container"><span class="avatar">ğŸ’</span></div>
                <div class="status-item">
                    <div class="label pixel-font">ãƒ¬ãƒ™ãƒ«</div>
                    <div class="value" id="playerLevel">1</div>
                </div>
                <div class="status-item">
                    <div class="label pixel-font">çµŒé¨“å€¤</div>
                    <div class="value" id="playerExp">0</div>
                </div>
                <div class="status-item">
                    <div class="label pixel-font">ã‚±ã‚¢ã‚¯ãƒªã‚¹ã‚¿ãƒ«</div>
                    <div class="value" id="playerCareCrystals">0</div>
                </div>
            </div>
            <div class="pq-card">
                <h3 class="pq-card-title">ä½“å¾—é€²æ—</h3>
                <p class="text-base text-gray-700">ç†è«–ã®ç†è§£åº¦: <span id="theoryProgress" class="font-bold">0</span>%</p>
                <p class="text-base text-gray-700">å®Ÿè·µå›æ•°: <span id="practiceCount" class="font-bold">0</span>å›</p>
                <div class="w-full bg-gray-300 rounded-full h-4 mt-2 shadow-inner">
                    <div id="overallProgress" class="bg-green-500 h-4 rounded-full flex items-center justify-center text-sm text-white pixel-font transition-all duration-500 ease-out" style="width: 0%">0%</div>
                </div>
            </div>
        </div>

        <div id="libraryScreen" class="screen">
            <h2 class="pixel-font text-2xl text-center mb-2 text-blue-600 font-bold">GADHAç†è«–å›³æ›¸é¤¨</h2>
            <div id="caretchiLibraryAdvice" class="caretchi-advice mb-4">ã‚±ã‚¢ã£ã¡ã€ŒçŸ¥ã‚ŠãŸã„ã“ã¨ã€ä½•ã§ã‚‚èã„ã¦ã­ï¼<span class="highlight">ä¸€ã¤ãšã¤</span>ç¢ºèªã—ã‚ˆã†ã€‚ã€</div>
            <div id="theoryContent" class="space-y-4"></div>
            <div class="pq-card mt-5">
                <h3 class="pq-card-title">ã‚±ã‚¢ã£ã¡ã«è³ªå•ã™ã‚‹</h3>
                <input type="text" id="libraryQuery" placeholder="ç†è«–ã«ã¤ã„ã¦è³ªå•ã‚’å…¥åŠ›..." class="mb-2">
                <button class="pq-button accent w-full" onclick="askCaretchiFromLibrary()">è³ªå•ã™ã‚‹</button>
                <div id="libraryAiResponse" class="ai-feedback mt-3" style="display:none;"></div>
            </div>
        </div>

        <div id="diaryScreen" class="screen">
            <h2 class="pixel-font text-2xl text-center mb-2 text-green-700 font-bold">å®Ÿè·µæ—¥è¨˜</h2>
            <div id="caretchiDiaryAdvice" class="caretchi-advice mb-4">ã‚±ã‚¢ã£ã¡ã€Œä»Šæ—¥ã®å‡ºæ¥äº‹ã€<span class="highlight">ã©ã‚“ãªå°ã•ãªã“ã¨ã§ã‚‚</span>è¨˜éŒ²ã—ã¦ã­ï¼ã€</div>
            <div class="flex gap-2 mb-4">
                <input type="text" id="diarySearchKeyword" placeholder="æ—¥è¨˜ã‚’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ¤œç´¢..." class="text-sm flex-grow">
                <button class="pq-button primary text-xs" onclick="searchDiary()">æ¤œç´¢</button>
            </div>
            <form id="practiceLogForm">
                <div class="mb-4">
                    <label for="diaryDate" class="block text-sm font-bold mb-1 pixel-font">æ—¥ä»˜ï¼š</label>
                    <input type="date" id="diaryDate" name="diaryDate" required class="text-sm">
                </div>
                <div class="mb-4">
                    <label for="diaryEntry" class="block text-sm font-bold mb-1 pixel-font">ä»Šæ—¥ã®æŒ¯ã‚Šè¿”ã‚Šï¼š<span class="small-text text-gray-600">(è‡ªç”±ã«è¨˜è¿°ã—ã¦ã­)</span></label>
                    <textarea id="diaryEntry" name="diaryEntry" rows="7" required placeholder="ä»Šæ—¥ã‚ã£ãŸã“ã¨ã€æ„Ÿã˜ãŸã“ã¨ã€GADHAç†è«–ã‚’ã©ã†æ„è­˜ã—ãŸã‹ãªã©..."></textarea>
                </div>
                <button type="submit" class="pq-button green w-full">æ—¥è¨˜ã‚’è¨˜éŒ²ï¼†ã‚±ã‚¢ã£ã¡è©•ä¾¡</button>
            </form>
            <div id="lastDiaryEvaluation" class="diary-evaluation mt-4" style="display:none;">
                <h3 class="pixel-font">ã‚±ã‚¢ã£ã¡ã®è©•ä¾¡</h3>
                <p id="evaluationText"></p>
                <div class="mt-2">
                    <strong class="pixel-font text-sm text-amber-700">ä»Šæ—¥æ´»ã‹ã›ãŸåŠ›ï¼š</strong>
                    <span id="evaluatedStrengthText" class="text-amber-700 font-bold"></span>
                </div>
            </div>
            <div id="diaryLogListContainer" class="mt-5">
                 <h3 class="text-xl font-bold mb-3 pixel-font text-center">éå»ã®æ—¥è¨˜</h3>
                <div id="diaryLogList"></div>
            </div>
        </div>

        <div id="customInfoScreen" class="screen">
            <h2 class="pixel-font text-2xl text-center mb-2 text-purple-600 font-bold">ã‚ãªãŸå°‚ç”¨æƒ…å ±</h2>
            <div id="caretchiCustomInfoAdvice" class="caretchi-advice mb-4">ã‚±ã‚¢ã£ã¡ã€Œã“ã‚Œã¯<span class="highlight">ã‚ãªãŸã ã‘</span>ã®ç‰¹åˆ¥ãªæƒ…å ±ã ã‚ˆï¼ã€</div>
            <div id="customInfoContent">
                </div>
            <button class="pq-button accent w-full mt-3" onclick="updateCustomInfoWithAI()">AIã§å°‚ç”¨æƒ…å ±ã‚’æ›´æ–°</button>
            <button class="pq-button primary w-full mt-1 text-sm" onclick="navigateToCaretchiWithCustomInfo()">ã“ã®æƒ…å ±ã«ã¤ã„ã¦ã‚±ã‚¢ã£ã¡ã¨è©±ã™</button>
        </div>

        <div id="aiSupportScreen" class="screen">
            <h2 class="pixel-font text-2xl text-center mb-2 text-orange-500 font-bold">AIã‚µãƒãƒ¼ã‚¿ãƒ¼ã€Œã‚±ã‚¢ã£ã¡ã€</h2>
            <div id="caretchiSupportAdvice" class="caretchi-advice mb-4">ã‚±ã‚¢ã£ã¡ã€Œã©ã‚“ãªã“ã¨ã§ã‚‚<span class="highlight">æ°—è»½ã«è©±ã—ã‹ã‘ã¦</span>ã­ï¼ã€</div>
            <div id="chatArea" class="h-72 overflow-y-auto border-2 border-gray-300 p-3 rounded-xl mb-3 bg-white shadow-inner">
                <div class="chat-bubble ai">ã“ã‚“ã«ã¡ã¯ï¼ã‚±ã‚¢ã£ã¡ã ã‚ˆã€‚ãªã‚“ã§ã‚‚è©±ã—ã¦ã­ã€‚</div>
            </div>
            <div class="flex gap-2">
                <input type="text" id="chatInput" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." class="flex-grow">
                <button class="pq-button accent" onclick="sendChatMessage()">é€ä¿¡</button>
            </div>
            <div id="actionableResponseArea" class="mt-4" style="display:none;">
                <p class="text-base text-gray-700">ã‚±ã‚¢ã£ã¡ã®ææ¡ˆï¼š<span id="suggestedActionText" class="font-bold"></span></p>
                <button class="pq-button primary text-sm mt-1" onclick="adoptAsActionGoal()">ã“ã‚Œã‚’ç›®æ¨™ã«ã™ã‚‹ï¼</button>
            </div>
        </div>
    </div>

    <div id="theoryModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('theoryModal')">&times;</span><h3 id="modalTitle" class="modal-title"></h3><div id="modalBody" class="text-gray-800 leading-relaxed text-base"></div><div class="text-center mt-5"><button class="pq-button primary mr-2" onclick="markAsRead()">èª­ã‚“ã ï¼</button><button class="pq-button accent" onclick="discussTheoryWithCaretchi()">ã“ã®å†…å®¹ã‚’ã‚±ã‚¢ã£ã¡ã¨æ·±ã‚ã‚‹</button></div></div></div>
    <div id="logModal" class="modal"><div class="modal-content"><span class="close-button" onclick="closeModal('logModal')">&times;</span><h3 id="logModalTitle" class="modal-title"></h3><div id="modalBody" class="text-gray-800 leading-relaxed text-base"></div><div class="text-center mt-5"><button class="pq-button accent" onclick="discussDiaryWithCaretchi()">ã“ã®æ—¥è¨˜ã‚’ã‚±ã‚¢ã£ã¡ã¨æŒ¯ã‚Šè¿”ã‚‹</button></div></div></div>

    <script type="module">
        // Firebase SDK Import
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, getDocs, query, orderBy, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        const GEMINI_API_KEY = ""; 
        const GEMINI_TEXT_MODEL = "gemini-2.0-flash";

        const userStrengthsFull = ["å†…çœ", "å­¦ç¿’æ¬²", "åé›†å¿ƒ", "é‹å‘½æ€è€ƒ", "ç€æƒ³", "æœ€ä¸Šæ€è€ƒ", "å€‹åˆ¥åŒ–", "è¦ªå¯†æ€§", "å…±æ„Ÿæ€§", "æˆé•·ä¿ƒé€²"];
        const userTopStrengths = userStrengthsFull.slice(0, 5);
        
        const gadhaTheoryData = {
            summary: {
                title: "GADHAç†è«– è¦ç´„",
                summary: "GADHAã®ç†è«–ã¯ã€åŠ å®³è€…ãŒè‡ªèº«ã®<span class='highlight'>åŠ å®³ã‚·ã‚¹ãƒ†ãƒ </span>ã‚’<span class='highlight'>ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ </span>ã¸ã¨å¤‰å®¹ã•ã›ã‚‹ãŸã‚ã®ç†è«–ã§ã™ã€‚",
                sections: [
                    { id: "summary_overview", title: "ç†è«–ã®æ ¸å¿ƒ", content: "åŠ å®³è€…ã¯ã€å¹¼å°‘æœŸã«åŠ å®³çš„ãªç’°å¢ƒã§è‚²ã¡ã€å‚·ã¤ãã‚’è² ã£ãŸçµæœã€è‡ªåˆ†ã‚’å®ˆã‚‹ãŸã‚ã«åŠ å®³çš„ãªä¿¡å¿µä½“ç³»ï¼ˆã‚·ã‚¹ãƒ†ãƒ ï¼‰ã‚’èº«ã«ã¤ã‘ã¦ãã¾ã—ãŸã€‚ã“ã®ä¿¡å¿µä½“ç³»ã¯ã€<span class='highlight'>ä¸€å…ƒè«–çš„ãªä¸–ç•Œè¦³</span>ï¼ˆä¸Šä¸‹é–¢ä¿‚ã‚„æ­£èª¤ãŒçµ¶å¯¾ï¼‰ã«åŸºã¥ã„ã¦ãŠã‚Šã€ä»–è€…ã‚’æ”¯é…ã—ã€æœå¾“ã•ã›ã‚‹ã“ã¨ã§è‡ªåˆ†ã®å­˜åœ¨ä¾¡å€¤ã‚’ç¢ºèªã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚ã—ã‹ã—ã€ã“ã‚Œã¯çœŸã®è§£æ±ºã«ã¯ãªã‚‰ãšã€åŠ å®³è€…è‡ªèº«ã¨å‘¨å›²ã®äººã€…ã‚’ä¸å¹¸ã«ã—ç¶šã‘ã¾ã™ã€‚<br><br>å¤‰å®¹ã¨ã¯ã€ã“ã®åŠ å®³ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ã€ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ ã¸ã¨å¤‰ãˆã¦ã„ãã“ã¨ã§ã™ã€‚ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ ã¯ã€<span class='highlight'>å¤šå…ƒçš„ãªä¸–ç•Œè¦³</span>ã«åŸºã¥ãã€ä»–è€…ã¨ã®é•ã„ã‚’èªã‚ã€äº’ã„ã®è§£é‡ˆã‚„ãƒ‹ãƒ¼ã‚ºã‚’å°Šé‡ã—ã€å…±åŒã§ä¸–ç•Œã‚’æ§‹ç¯‰ã—ã¦ã„ãã“ã¨ã‚’ç›®æŒ‡ã—ã¾ã™ã€‚<br><br>å¤‰å®¹ã®ãŸã‚ã«ã¯ã€ã¾ãšè‡ªåˆ†ã®åŠ å®³çš„ãªè¨€å‹•ã‚’è‡ªè¦šã—ã€ãã®èƒŒå¾Œã«ã‚ã‚‹ä¿¡å¿µã‚’ç†è§£ã™ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚ãã—ã¦ã€ã‚±ã‚¢ã«åŸºã¥ã„ãŸè¨€å‹•ã‚’è©¦ã—ã€ãã®çµæœã‹ã‚‰å­¦ã³ã€å¾ã€…ã«ä¿¡å¿µã‚’å¤‰å®¹ã•ã›ã¦ã„ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚", unlocked: true },
                ]
            },
            normative: {
                title: "è¦ç¯„ç·¨ï¼šå¤‰å®¹ã™ã‚‹ã¨ã¯ï¼Ÿ",
                summary: "ï½¢è‡ªåˆ†ï½£ã¨ã„ã†<span class='highlight'>åŠ å®³ã®ã‚·ã‚¹ãƒ†ãƒ </span>ã‚’<span class='highlight'>ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ </span>ã«å¤‰ãˆã¦ã„ãã“ã¨ã§ã™ã€‚",
                sections: [
                    { id: "norm_sec1", title: "ã‚·ã‚¹ãƒ†ãƒ æ€è€ƒã¨æ°·å±±ãƒ¢ãƒ‡ãƒ«", content: "GADHAã®ç†è«–ã§ã¯ã€å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«<span class='highlight'>ã‚·ã‚¹ãƒ†ãƒ æ€è€ƒ</span>ã‚’ç”¨ã„ã¾ã™ã€‚å‡ºæ¥äº‹ã‚’å˜ä½“ã§æ‰ãˆã‚‹ã®ã§ã¯ãªãã€ãã®èƒŒå¾Œã«ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€æ§‹é€ ã€ä¾¡å€¤è¦³ï¼ˆãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ï¼‰ã¨ã®é–¢é€£æ€§ã‚’ç†è§£ã—ã‚ˆã†ã¨ã™ã‚‹è€ƒãˆæ–¹ã§ã™ã€‚<br><br>æ°·å±±ãƒ¢ãƒ‡ãƒ«ã‚’ç”¨ã„ã¦èª¬æ˜ã™ã‚‹ã¨ã€æ°´é¢ä¸Šã«è¦‹ãˆã‚‹ã€Œå‡ºæ¥äº‹ã€ï¼ˆä¾‹ï¼šé¢¨é‚ªã‚’ã²ãï¼‰ã¯ã€æ°´é¢ä¸‹ã®ã€Œè¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã€ï¼ˆä¾‹ï¼šç¡çœ ä¸è¶³ï¼‰ã€ã€Œæ§‹é€ ã€ï¼ˆä¾‹ï¼šä»•äº‹ã®å¿™ã—ã•ã«ã‚ˆã‚‹ã‚¹ãƒˆãƒ¬ã‚¹ï¼‰ã€ã€Œä¾¡å€¤è¦³ã€ï¼ˆä¾‹ï¼šä»•äº‹ã®ã‚­ãƒ£ãƒªã‚¢å„ªå…ˆï¼‰ã¨ç¹‹ãŒã£ã¦ã„ã¾ã™ã€‚<br><br>çœŸã®å•é¡Œè§£æ±ºã«ã¯ã€è¡¨å±¤çš„ãªå‡ºæ¥äº‹ã ã‘ã§ãªãã€æ·±å±¤ã«ã‚ã‚‹ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã‚’ç†è§£ã—ã€ç‰¹ã«<span class='highlight'>ä¾¡å€¤è¦³ãƒ¬ãƒ™ãƒ«ã§ã®å¤‰å®¹ãŒå¿…è¦</span>ã¨ãªã‚Šã¾ã™ã€‚", unlocked: true },
                    { id: "norm_sec2", title: "åŠ å®³ã®ã‚·ã‚¹ãƒ†ãƒ ã¨ã¯ï¼Ÿ", content: "åŠ å®³ã®ä¿¡å¿µä½“ç³»ã‚’æŒã¤äººãŒç”Ÿã¿å‡ºã™ã®ã¯<span class='highlight'>æ”¯é…ã¨æœå¾“ã®é–¢ä¿‚</span>ã§ã™ã€‚<br><br>ä¾‹ï¼šã€Œç›¸æ‰‹ã«ã¨ã£ã¦è‰¯ã„ã¨æ€ã‚ã‚Œã‚‹ã“ã¨ã‚’ã—ãŸã®ã«ç›¸æ‰‹ãŒå–œã°ãªã„æ™‚ã€ã«ã€Œãªã‚“ã§ãŠå‰ã¯ç´ ç›´ã«å–œã°ãªã„ã‚“ã ã€ã¨ç›¸æ‰‹ã‚’ãªã˜ã‚Šã€è‡ªåˆ†ã®è€ƒãˆã‚’æŠ¼ã—ä»˜ã‘ã¾ã™ã€‚<br><br>ã“ã®èƒŒæ™¯ã«ã¯ã€<span class='highlight'>ä¸€å…ƒè«–çš„ãªä¾¡å€¤è¦³</span>ï¼ˆä¸Šä¸‹é–¢ä¿‚ã€æ­£èª¤ã®çµ¶å¯¾è¦–ã€äººã‚’å¾“ã‚ã›ã‚‹ã“ã¨ãŒå–„ï¼‰ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ä¸–ç•Œè¦³ã§ã¯ã€è‡ªåˆ†ã¯å¸¸ã«æ­£ã—ãã€ç›¸æ‰‹ãŒé–“é•ã£ã¦ã„ã‚‹ã¨è€ƒãˆãŒã¡ã§ã™ã€‚", unlocked: true },
                    { id: "norm_sec3", title: "ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ ã¨ã¯ï¼Ÿ", content: "ã‚±ã‚¢ã®ä¿¡å¿µä½“ç³»ã§ã¯ã€åŒã˜çŠ¶æ³ã§ã‚‚åå¿œãŒç•°ãªã‚Šã¾ã™ã€‚<br><br>ä¾‹ï¼šã€Œå–œã‚“ã§æ¬²ã—ã‹ã£ãŸã‘ã©ä½•ã‹é•ã£ãŸã‹ãªï¼Ÿã€ã¨è€ƒãˆã€ã€Œå‰ã¯èµ¤è‰²ãŒå¥½ãã ã¨è¨€ã£ã¦ãŸã‘ã©å¥½ã¿ãŒå¤‰ã‚ã£ãŸã‹ãªï¼Ÿã€ã¨<span class='highlight'>å¯¾è©±ã‚’é€šã˜ã¦ç†è§£</span>ã‚’æ·±ã‚ã‚ˆã†ã¨ã—ã¾ã™ã€‚<br><br>èƒŒæ™¯ã«ã¯ã€ä¸–ç•Œã¯<span class='highlight'>å¤šå…ƒçš„</span>ã§ã‚ã‚Šã€äººã€…ã¯ãã‚Œãã‚Œç•°ãªã‚‹ä¾¡å€¤è¦³ã‚’æŒã¤ã¨ã„ã†èªè­˜ãŒã‚ã‚Šã¾ã™ã€‚<br><br>å¹¸ç¦ã¨ã¯ã€è‡ªåˆ†ãŒè‡ªåˆ†ã‚‰ã—ãã‚ã‚Šã€ä»–è€…ã‚‚ãã®äººã‚‰ã—ãã„ã‚‰ã‚Œã‚‹ã“ã¨ã€‚ãã®ãŸã‚ã«ã¯ã€äº’ã„ã®è§£é‡ˆã‚„ãƒ‹ãƒ¼ã‚ºã‚’å°Šé‡ã—ã€<span class='highlight'>å…±åŒã§ä¸–ç•Œã‚’æ§‹ç¯‰</span>ã—ã¦ã„ãã“ã¨ãŒé‡è¦ã§ã™ã€‚", unlocked: true },
                    { id: "norm_sec4", title: "å¤‰å®¹ã®å®šç¾©", content: "å¤‰å®¹ã¨ã¯ã€ï½¢<span class='highlight'>åŠ å®³ã®ã‚·ã‚¹ãƒ†ãƒ ã‚’ã€ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ ã«å¤‰ãˆã‚‹</span>ï½£ã“ã¨ã§ã™ã€‚ã“ã‚Œã«å–ã‚Šçµ„ã‚€ã®ãŒGADHAã«ãŠã‘ã‚‹åŠ å®³è€…å¤‰å®¹ã§ã™ã€‚", unlocked: true }
                ]
            },
            transformation: {
                title: "å¤‰å®¹ç·¨ï¼šã©ã†ã™ã‚Œã°å¤‰ã‚ã‚Œã‚‹ã‹ï¼Ÿ",
                summary: "<span class='highlight'>è¨€å‹•ã‚’å¤‰ãˆã€çµæœãŒå¤‰ã‚ã‚Šã€ä¿¡å¿µãŒå¤‰ã‚ã‚‹ã€‚</span>ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã™ã“ã¨ãŒå¤‰å®¹ã®éµã§ã™ã€‚",
                sections: [
                    { id: "trans_sec1", title: "ã¾ãšè¡Œå‹•ã‚’å¤‰ãˆã‚‹é‡è¦æ€§", content: "ä¿¡å¿µã¯ã™ãã«ã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚ä¿¡ã˜ã‚‰ã‚Œãªãã¦ã‚‚ã„ã„ã®ã§ã€<span class='highlight'>ã‚±ã‚¢ã«åŸºã¥ã„ãŸè¨€å‹•ã‚’è©¦ã—ã¦</span>ã¿ã‚‹ã“ã¨ãŒç¬¬ä¸€æ­©ã§ã™ã€‚<br><br>è¨€å‹•ãŒå¤‰ã‚ã‚Œã°ã€ç•°ãªã‚‹çµæœãŒç”Ÿã˜ã€ãã®çµæœãŒè‡ªåˆ†ã«ã¨ã£ã¦è‰¯ã„ã‚‚ã®ã§ã‚ã£ãŸæ™‚ã«ã€äººã®ä¿¡å¿µã¯å¤‰åŒ–ã—ã¾ã™ã€‚<br><br>GADHAã§ã¯æ€æƒ³ã‚„çŸ¥è­˜ã‚‚å¤§åˆ‡ã§ã™ãŒã€<span class='highlight'>å®Ÿè·µãŒéå¸¸ã«é‡è¦</span>ã«ãªã‚Šã¾ã™ã€‚", unlocked: true },
                    { id: "trans_sec2", title: "è¡Œå‹•ã¨ä¿¡å¿µã®ã‚µã‚¤ã‚¯ãƒ«", content: "ã‚ã‚‹ç’°å¢ƒã§ä¿¡å¿µAã«åŸºã¥ãè¡Œå‹•ã—æ‚ªã„çµæœãªã‚‰ä¿¡å¿µAã‚’ç ´æ£„ã€‚ä¿¡å¿µBã§è‰¯ã„çµæœãªã‚‰ä¿¡å¿µBã‚’å¼·åŒ–ã—ã¾ã™ã€‚<br><br>ã—ã‹ã—ã€ç’°å¢ƒãŒå¤‰ã‚ã‚‹ã¨ã€ã‹ã¤ã¦æ©Ÿèƒ½ã—ãŸä¿¡å¿µBãŒæ‚ªã„çµæœã‚’ç”Ÿã‚€ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚<br><br>ã“ã“ã§<span class='highlight'>å‹‡æ°—ã‚’å‡ºã—ã¦é•ã†è¡Œå‹•ã‚’å–ã‚‹</span>ã“ã¨ãŒå¿…è¦ã§ã™ã€‚ãã®ãŸã‚ã«ã¯ã€ã¾ãšã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ ã¨ã„ã†<span class='highlight'>æ–°ã—ã„è¡Œå‹•ã®é¸æŠè‚¢ã‚’çŸ¥ã‚‹</span>ã“ã¨ãŒå‰æã¨ãªã‚Šã¾ã™ã€‚", unlocked: true },
                    { id: "trans_sec3", title: "è‡ªåˆ†ãŒé–“é•ã†å¯èƒ½æ€§ã®èªè­˜", content: "è‡ªåˆ†ã®ä¿¡å¿µã‚’çµ¶å¯¾è¦–ã›ãšã€<span class='highlight'>é–“é•ã†å¯èƒ½æ€§ãŒã‚ã‚‹</span>ã¨æ°—ã¥ãã“ã¨ãŒé‡è¦ã§ã™ã€‚ãã†ã§ãªã‘ã‚Œã°è¡Œå‹•ã‚’å¤‰ãˆã‚‰ã‚Œãšã€çµæœã‚‚ä¿¡å¿µã‚‚å¤‰ã‚ã‚Šã¾ã›ã‚“ã€‚<br><br>æ‚ªã„çµæœã‚’ä»–è²¬ã«ã›ãšå—ã‘å…¥ã‚Œã‚‹ã“ã¨ã¯è‘›è—¤ã‚„è™šç„¡æ„Ÿã‚’ä¼´ã„ã¾ã™ãŒã€ãã‚Œã‚’ä¹—ã‚Šè¶Šãˆæ–°ã—ã„è¡Œå‹•ã‚’è©¦ã™ã“ã¨ã§ã€Œä¸€çš®ã‚€ã‘ã‚‹ã€ï¼å¤‰å®¹å­¦ç¿’ãŒèµ·ã“ã‚Šã¾ã™ã€‚", unlocked: true },
                    { id: "trans_sec4", title: "åŠ å®³è€…å¤‰å®¹ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—æ¦‚è¦³", content: "å¤‰å®¹ã¯ä¸€ç›´ç·šã§ã¯ãªãã€é€²ã‚“ã ã¨æ€ã£ã¦ã‚‚åŠ å®³è¨€å‹•ã«æˆ»ã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚<br><br>ã€Œé–¢ä¿‚ã®å±æ©Ÿã€â†’ã€Œå•é¡Œã®è‡ªè¦šã€â†’ã€ŒçŸ¥è­˜ã®ç²å¾—ã€â†’ã€Œå®Ÿè·µã¨ä¿®æ­£ã€â†’ã€Œä¼é“ã¨ææ¡ˆã€â†’ã€Œç¾å¾³ã®ç™ºæ®ã€ã¨ã„ã†ãƒ—ãƒ­ã‚»ã‚¹ã‚’è¾¿ã‚Šã¾ã™ã€‚<br><br>å„æ®µéšã§<span class='highlight'>ä»²é–“ã®æ”¯ãˆ</span>ãŒä¸å¯æ¬ ã§ã™ã€‚", unlocked: true }
                ]
            },
            happiness: {
                title: "å¹¸ç¦ç·¨ï¼šå¤‰å®¹ã§å¾—ã‚‰ã‚Œã‚‹å¹¸ç¦",
                summary: "<span class='highlight'>å­˜åœ¨ã®å—å®¹</span>ã¨ã€äººé–“å­˜åœ¨ã®<span class='highlight'>æ ¹æºçš„ãªå®‰å¿ƒ</span>ã‚’ä¸ãˆåˆãˆã‚‹é–¢ä¿‚ã§ã™ã€‚",
                sections: [
                    { id: "happy_sec1", title: "å­˜åœ¨ã®å—å®¹ã¨ã„ã†å¹¸ç¦", content: "äººé–“ã¯è§£é‡ˆã™ã‚‹ç”Ÿãç‰©ã§ã‚ã‚Šã€æ•…ã«å‚·ã¤ãå¼±ã„ç”Ÿãç‰©ã§ã™ã€‚è‡ªåˆ†ã®è§£é‡ˆã¨ä»–è€…ã®è§£é‡ˆãŒã‚ºãƒ¬ãŸæ™‚ã€å‚·ã¤ãã¾ã™ï¼ˆãƒ‹ãƒ¼ã‚ºãŒç”Ÿã˜ã‚‹ï¼‰ã€‚<br><br>ã“ã®<span class='highlight'>ãƒ‹ãƒ¼ã‚ºã‚’ã‚±ã‚¢ã—åˆã†</span>ã“ã¨ã€ã‚ã‚Šã®ã¾ã¾ã®å­˜åœ¨ã‚’èªã‚åˆã†ã“ã¨ãŒå¹¸ç¦ã®æ ¸ã§ã™ã€‚<br><br>è‡ªåˆ†ã®ãƒ‹ãƒ¼ã‚ºãŒèª°ã‹ã«æº€ãŸã•ã‚Œã‚‹ã“ã¨ä»¥ä¸Šã«ã€<span class='highlight'>ã‚±ã‚¢ã‚’ã—ã‚ˆã†ã¨ã—ã¦ãã‚Œã‚‹äººãŒã„ã‚‹ã“ã¨</span>ãŒæ ¹æºçš„ãªå®‰å¿ƒã«ç¹‹ãŒã‚Šã¾ã™ã€‚", unlocked: true },
                    { id: "happy_sec2", title: "æ„›ã—åˆã†ã¨ã¯ä½•ã‹ï¼Ÿ", content: "æ„›ã¨ã¯ã€ç›¸æ‰‹ã®å‚·ã¤ãï¼ˆãƒ‹ãƒ¼ã‚ºï¼‰ã‚’èªã‚ã€ãã‚Œã‚’ã‚±ã‚¢ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨ã§ã™ã€‚<span class='highlight'>ç›¸æ‰‹ã®ä¸–ç•Œã«å¯„ã‚Šæ·»ãŠã†ã¨ã™ã‚‹</span>å…·ä½“çš„ãªè¡Œå‹•ã§ã™ã€‚<br><br>ãŠäº’ã„ã«ãã‚ŒãŒã§ãã‚‹ã¨ã€è‡ªåˆ†ã®æ„Ÿã˜æ–¹ã‚„è€ƒãˆæ–¹ã‚’æ”»æ’ƒã•ã‚Œã‚‹å¿ƒé…ãŒãªããªã‚Šã€<span class='highlight'>ã€Œç§ãŸã¡ã®ä¸–ç•Œã€ã‚’æ§‹ç¯‰</span>ã§ãã€å­˜åœ¨ãŒå®‰å®šã—ã¾ã™ã€‚", unlocked: true },
                     { id: "happy_sec3", title: "æŒç¶šå¯èƒ½ãªå¹¸ç¦ã¨ã¯ï¼Ÿ", content: "GADHAã§ã¯<span class='highlight'>å—å®¹å‹ã®å¹¸ç¦</span>ï¼ˆã‚ã‚Šã®ã¾ã¾ã®è‡ªåˆ†ã‚’å—ã‘å®¹ã‚Œã‚‹ï¼‰ã‚’æ¡ç”¨ã—ã¾ã™ã€‚å®Ÿç¾å‹ã‚„æ²¡å…¥å‹ã®å¹¸ç¦ã¯æŒç¶šãŒé›£ã—ã„ã‹ã‚‰ã§ã™ã€‚<br><br>å¹¸ç¦ã¨ã¯è‡ªåˆ†ã®å‚·ã¤ãã€å¼±ã•ã€ä¸å®Œå…¨ã•ã‚’å—ã‘å®¹ã‚Œã¦ç”Ÿãã‚‹ã“ã¨ã€‚ãã‚ŒãŒè‡ªç„¶ãªã“ã¨ã ã¨ç†è§£ã™ã‚‹ã“ã¨ã§ã™ã€‚", unlocked: true },
                ]
            },
            behavior: {
                title: "è¨€å‹•ç·¨ï¼šå…·ä½“çš„ãªã‚±ã‚¢ã¨ã¯ï¼Ÿ",
                summary: "<span class='highlight'>æ„Ÿè¦šã®å¦å®šã‚’ã›ãš</span>ã€<span class='highlight'>æƒ…å‹•èª¿å¾‹</span>ï¼ˆç›¸æ‰‹ã®æ„Ÿæƒ…ã‚„æ„Ÿè¦šã‚’ç†è§£ã—å—å®¹ã™ã‚‹ï¼‰ã‚’å¿ƒãŒã‘ã‚‹ã“ã¨ã§ã™ã€‚",
                sections: [
                    { id: "behav_sec1", title: "æ„Ÿè¦šã®å¦å®šã¯åŠ å®³", content: "ã€Œè€ƒãˆã™ãã€ã€Œãã‚“ãªã“ã¨ã§æ€’ã‚‹ãªã€ã¨ã„ã£ãŸè¨€è‘‰ã¯ã€ç›¸æ‰‹ã®æ„Ÿè¦šã‚’å¦å®šã—ã€å­˜åœ¨ã‚’æ ¹åº•ã‹ã‚‰æºã‚‹ãŒã™æš´åŠ›ã§ã™ã€‚<br><br>ç›¸æ‰‹ã®æ„Ÿè¦šã‚’å°Šé‡ã™ã‚‹ã«ã¯ã€<span class='highlight'>è¨€è‘‰ã‚’é¸ã¶</span>ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚", unlocked: true },
                    { id: "behav_sec2", title: "æƒ…å‹•èª¿å¾‹ï¼ˆèªè­˜çš„å…±æ„Ÿï¼‰", content: "æƒ…å‹•èª¿å¾‹ã¨ã¯ã€ç›¸æ‰‹ã®æ„Ÿè¦šã‚„ä¿¡å¿µã‚’<span class='highlight'>ã‚ã‹ã‚ã†ã¨ã—ã€ãã‚Œã‚’å—å®¹ã™ã‚‹</span>ã“ã¨ã§ã™ã€‚ã€Œã‚ãªãŸã¯ã“ã†æ„Ÿã˜ã‚‹ã®ã ã­ã€ã¨ãã®ã¾ã¾å—ã‘æ­¢ã‚ã‚‹ã“ã¨ã€‚<br><br>ç›¸æ‰‹ã¨åŒã˜ã‚ˆã†ã«æ„Ÿã˜ã‚‹ã“ã¨ï¼ˆæƒ…å‹•çš„å…±æ„Ÿï¼‰ã¨ã¯ç•°ãªã‚Šã¾ã™ã€‚<br><br>æƒ…å‹•èª¿å¾‹ã—ã‚ˆã†ã¨ã™ã‚‹ã“ã¨è‡ªä½“ãŒã€ç›¸æ‰‹ã«å®‰å¿ƒã‚’ä¸ãˆã¾ã™ã€‚", unlocked: true },
                    { id: "behav_sec3", title: "åŠ å®³è€…ã¯è‡ªåˆ†ã«ã‚‚æƒ…å‹•èª¿å¾‹ã§ããªã„", content: "åŠ å®³è€…ã¯ã€ä»–è€…ã¨ã®è§£é‡ˆã®ã‚ºãƒ¬ã§å‚·ã¤ã„ã¦ã‚‚ã€ãã®å‚·ã¤ãã‚„å¼±ã•ã‚’èªã‚ã‚‰ã‚Œã¾ã›ã‚“ã€‚ãã®ãŸã‚ã€æ€’ã‚Šã‚„æ”¯é…ã§ã‚±ã‚¢ã‚’è¦æ±‚ã—ã¾ã™ã€‚<br><br>è‡ªåˆ†ã®ãƒ‹ãƒ¼ã‚ºã‚’èªã‚ã€é©åˆ‡ã«ä¾é ¼ã—ã€ã‚±ã‚¢ã—ã¦ã‚‚ã‚‰ã£ãŸã“ã¨ã«æ„Ÿè¬ã™ã‚‹ã“ã¨ãŒã€ç›¸äº’ã®ã‚±ã‚¢äº¤æ›ã«ã¯ä¸å¯æ¬ ã§ã™ã€‚", unlocked: true }
                ]
            },
            belief: {
                title: "ä¿¡å¿µç·¨ï¼šåŠ å®³çš„ãªä¿¡å¿µã‚’æ‰‹æ”¾ã™",
                summary: "åŠ å®³çš„ãªä¿¡å¿µï¼ˆä¾‹ï¼šã¹ãè«–ã€ä¸Šä¸‹é–¢ä¿‚ï¼‰ã¯<span class='highlight'>å†…é¢åŒ–ã•ã‚ŒãŸä»–è€…ã®å£°</span>ã€‚ãã‚Œã‚’ã‚±ã‚¢ã®ä¿¡å¿µï¼ˆå¤šå…ƒæ€§ã€ç›¸äº’å°Šé‡ï¼‰ã«å¤‰ãˆã¾ã™ã€‚",
                sections: [
                    { id: "belief_sec1", title: "åŠ å®³çš„ãªä¿¡å¿µã®ä¾‹", content: "ã€Œç›¸æ‰‹ã®æ„Ÿã˜æ–¹ãŒé–“é•ã£ã¦ã„ã‚‹ã€ã€ŒãŠå‰ã¯è‡ªåˆ†ã®ãŸã‚ã®é“å…·ã ã€ã€Œãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ãªã‚‰åˆ†ã‹ã£ã¦å½“ç„¶ã€ãªã©ãŒã‚ã‚Šã¾ã™ã€‚<br><br>ã“ã‚Œã‚‰ã®ä¿¡å¿µã¯ã€Œæ­£ã—ã„/é–“é•ã„ã€ã§ã¯ãªãã€ãã‚Œæ•…ã«äººã‚’å‚·ã¤ã‘ã¦ã—ã¾ã†ã¨ã„ã†æ€§è³ªã®ã‚‚ã®ã§ã™ã€‚", unlocked: true },
                    { id: "belief_sec2", title: "ä¿¡å¿µã¯å†…é¢åŒ–ã•ã‚ŒãŸä»–è€…ã®å£°", content: "ä¿¡å¿µã¯ç”Ÿã¾ã‚ŒæŒã£ãŸã‚‚ã®ã§ã¯ãªãã€è‚²ã£ãŸç’°å¢ƒã‚„ç¤¾ä¼šã‹ã‚‰å­¦ç¿’ã—ã€<span class='highlight'>ä»•æ–¹ãªãèº«ã«ã¤ã‘ã¦ããŸ</span>ã‚‚ã®ã§ã™ã€‚<br><br>ã€Œã“ã‚Œã¯æœ¬å½“ã«è‡ªåˆ†ã®å£°ã ã£ãŸã ã‚ã†ã‹ã€ã¨å•ã„ç›´ã—ã€æ¡ç”¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’è‡ªåˆ†ã§æ±ºã‚ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚", unlocked: true },
                    { id: "belief_sec3", title: "ä¸€å…ƒè«–çš„ä¸–ç•Œè¦³ã¨å¤šå…ƒè«–çš„ä¸–ç•Œè¦³", content: "åŠ å®³çš„ä¿¡å¿µã¯<span class='highlight'>ä¸€å…ƒè«–</span>ï¼ˆä¸Šä¸‹ã€æ­£èª¤ã€ä¸­å¿ƒã¨å‘¨è¾ºï¼‰ã«åŸºã¥ãã¾ã™ã€‚ã‚±ã‚¢ã®ä¿¡å¿µã¯<span class='highlight'>å¤šå…ƒè«–</span>ï¼ˆå¤šæ§˜ãªä¾¡å€¤è¦³ã‚„æ­£ã—ã•ãŒçŸ›ç›¾ã—ã¤ã¤å…±å­˜ï¼‰ã«åŸºã¥ãã¾ã™ã€‚<br><br>è‡ªåˆ†ã®è€ƒãˆã¨é•ã†ã‚‚ã®ã‚’è¨±ã•ãªã„ã“ã¨ã¯æš´åŠ›ã§ã™ã€‚ç¢ºã‹ãªä¿¡å¿µã‚’æŒã¡ã¤ã¤ã‚‚ã€é–“é•ã„ã‚’èªã‚ã‚‹ã€Œã—ãªã‚„ã‹ãªç¢ºã‹ã•ã€ãŒå¤§åˆ‡ã§ã™ã€‚", unlocked: true }
                ]
            },
            structure: {
                title: "æ§‹é€ ç·¨ï¼šåŠ å®³ã®é€£é–ã‚’æ–­ã¡åˆ‡ã‚‹",
                summary: "åŠ å®³è€…ã¯ã‹ã¤ã¦è¢«å®³è€…ã ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚ãã®<span class='highlight'>å‚·ã¤ãã‚’ç™’ã—</span>ã€<span class='highlight'>ã‚±ã‚¢ã®é€£é–</span>ã‚’å§‹ã‚ã‚‹ã“ã¨ãŒå„Ÿã„ã«ã‚‚ç¹‹ãŒã‚Šã¾ã™ã€‚",
                sections: [
                    { id: "struct_sec1", title: "åŠ å®³ã®èµ·æºã¨é˜²è¡›åå¿œ", content: "åŠ å®³ã®èµ·æºã¯ã€ä¸»ãŸã‚‹é¤Šè‚²è€…ã‹ã‚‰å—ã‘ãŸè¢«å®³ã§ã‚ã‚‹å ´åˆãŒã»ã¨ã‚“ã©ã§ã™ã€‚ç”Ÿãæ®‹ã‚‹ãŸã‚ã«ã€ŒFight(æˆ¦é—˜)ã€ã€ŒFleet(é€ƒé¿)ã€ã€ŒFreeze(è§£é›¢)ã€ã€ŒFawn(å¿–åº¦)ã€ã¨ã„ã£ãŸé˜²è¡›åå¿œã‚’èº«ã«ã¤ã‘ã€ãã‚ŒãŒåŠ å®³çš„ãªä¿¡å¿µã¨ãªã£ã¦ã„ã¾ã™ã€‚", unlocked: true },
                    { id: "struct_sec2", title: "éå»ã®å‚·ã¨ç¾åœ¨ã®ç—›ã¿", content: "é¤Šè‚²ç’°å¢ƒã§å—ã‘ãŸå‚·ã¤ãã¯ã€<span class='highlight'>ä»Šã‚‚ç¾åœ¨é€²è¡Œå½¢ã®ç—›ã¿</span>ï¼ˆãƒˆãƒ©ã‚¦ãƒã«ã‚ˆã‚‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒãƒƒã‚¯ãªã©ï¼‰ã¨ã—ã¦æ®‹ã£ã¦ã„ã¾ã™ã€‚<br><br>ã“ã®ç—›ã¿ã‚’ã‚±ã‚¢ã™ã‚‹ã“ã¨ãªã—ã«ã¯ã€ä»–è€…ã®ç—›ã¿ã‚‚ç†è§£ã§ãã¾ã›ã‚“ã€‚", unlocked: true },
                    { id: "struct_sec3", title: "æŒç¶šä¸å¯èƒ½ãªã‚»ãƒ«ãƒ•ã‚±ã‚¢ï¼ˆä¾å­˜ï¼‰", content: "å‚·ã¤ãã‚’ç™’ã™æ–¹æ³•ã‚’çŸ¥ã‚‰ãªã„ãŸã‚ã€ã‚¢ãƒ«ã‚³ãƒ¼ãƒ«ã€ã‚®ãƒ£ãƒ³ãƒ–ãƒ«ã€æ€§è¡Œç‚ºã€ã‚ã‚‹ã„ã¯åŠ å®³è¡Œç‚ºãã®ã‚‚ã®ã¨ã„ã£ãŸ<span class='highlight'>ä¾å­˜è¡Œå‹•ã§ç—›ã¿ã‚’éº»ç—º</span>ã•ã›ã‚ˆã†ã¨ã—ã¾ã™ã€‚<br><br>ã“ã‚Œã‚‰ã¯å…¨ã¦ã€ç²¾ç¥çš„ãªå‚·ã¤ãã‹ã‚‰ã®é€ƒé¿è¡Œå‹•ã§ã™ã€‚", unlocked: true },
                    { id: "struct_sec4", title: "å„Ÿã„ã¨ã‚±ã‚¢ã®é€£é–", content: "ç§ãŸã¡ã¯è¢«å®³è€…ã«å¯¾ã—ã¦è² å‚µã‚’æŠ±ãˆã¦ã„ã¾ã™ã€‚å„Ÿã„ã¨ã¯ã€<span class='highlight'>è‡ªä»–ã¨ã‚‚ã«æŒç¶šå¯èƒ½ãªå½¢ã§ç›¸äº’ã«ã‚±ã‚¢ã§ãã‚‹é–¢ä¿‚</span>ã‚’æ§‹ç¯‰ã™ã‚‹ã“ã¨ã‚’ç›®æŒ‡ã™ã“ã¨ã§ã™ã€‚<br><br>ãƒŸã‚¯ãƒ­ï¼ˆå€‹äººï¼‰ã®å¤‰å®¹ãŒã€ãƒã‚¯ãƒ­ï¼ˆç¤¾ä¼šï¼‰ã®åŠ å®³ã®é€£é–ã‚’æ–­ã¡åˆ‡ã‚‹èµ·ç‚¹ã¨ãªã‚Šã¾ã™ã€‚ã‚±ã‚¢ã‚‚ã¾ãŸé€£é–ã—ã¾ã™ã€‚", unlocked: true }
                ]
            }
        };
        
        let playerState = {
            level: 1, exp: 0, careCrystals: 0,
            todayActionGoal: "GADHAç†è«–ã®ã€Œè¦ç¯„ç·¨ã€ã‚’èª­ã‚“ã§ã¿ã‚ˆã†ï¼",
            todayActionGoalHint: "ã‚±ã‚¢ã£ã¡ã€Œè¦ç¯„ç·¨ã§ã¯ã€åŠ å®³ã¨ã‚±ã‚¢ã®ã‚·ã‚¹ãƒ†ãƒ ã®é•ã„ãŒåˆ†ã‹ã‚‹ã‚ˆã€‚ã¾ãšã¯ãã“ã‹ã‚‰ã ã­ï¼ã€", 
            theoryReadSections: {},
            customInfoLastUpdate: null,
            customInfoText: `
                <div class="pq-card">
                    <h3 class="pq-card-title">ã‚ãªãŸã®å¼·ã¿ (Top5)</h3>
                    <ul id="strengthsListInternal" class="list-disc list-inside text-sm text-gray-700 space-y-1">
                        ${userTopStrengths.map(s => `<li><span class="font-bold">${s}</span></li>`).join('')}
                    </ul>
                    <p class="mt-3 text-xs text-gray-600">ã“ã‚Œã‚‰ã®<span class="highlight">ç´ æ™´ã‚‰ã—ã„åŠ›</span>ã‚’ã€GADHAç†è«–ã®å®Ÿè·µã«æ´»ã‹ã—ã¦ã„ãã¾ã—ã‚‡ã†ï¼</p>
                </div>
                <div class="pq-card">
                    <h3 class="pq-card-title">ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒªã«ã¤ã„ã¦</h3>
                    <p class="text-sm text-gray-700">æƒ…å ±ã‚’ä¸€æ™‚çš„ã«è¨˜æ†¶ã—ãªãŒã‚‰å‡¦ç†ã™ã‚‹åŠ›ï¼ˆWMI:82ï¼‰ã¯ã€å¹³å‡ã‚ˆã‚Šå°‘ã—ä½ã„å‚¾å‘ã§ã™ãŒã€å¿ƒé…ã„ã‚Šã¾ã›ã‚“ï¼<br>
                        <span class="highlight">æƒ…å ±ã‚’å°åˆ†ã‘ã«ã™ã‚‹</span>ã€<span class="highlight">ãƒ¡ãƒ¢ã‚’å–ã‚‹</span>ã€<span class="highlight">å›³ã‚„çµµã§ç†è§£ã™ã‚‹</span>ãªã©ã®å·¥å¤«ã§ã€ã‚ãªãŸã®ã€Œå­¦ç¿’æ¬²ã€ã‚„ã€Œåé›†å¿ƒã€ã¯ååˆ†ã«æ´»ã‹ã›ã¾ã™ã€‚<br>
                        ç†è«–å­¦ç¿’ã‚‚ã€ä¸€åº¦ã«å…¨éƒ¨ã‚’è¦šãˆã‚ˆã†ã¨ã›ãšã€<span class="highlight">ã€Œä»Šæ—¥ã¯ã“ã®éƒ¨åˆ†ã ã‘ã€</span>ã¨æ±ºã‚ã¦å–ã‚Šçµ„ã‚€ã®ãŒãŠã™ã™ã‚ã§ã™ã€‚
                    </p>
                </div>
                 <div class="pq-card">
                    <h3 class="pq-card-title">å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³</h3>
                    <ul class="list-disc list-inside text-sm text-gray-700 space-y-1">
                        <li><span class="font-bold">ä¾¡å€¤ã‚ã‚‹é¸æŠè‚¢ã®å‰µé€ :</span> <span class="highlight">ã‚ãªãŸã‚‰ã—ã•</span>ã‚’æ´»ã‹ã—ã€æ–°ã—ã„å¯èƒ½æ€§ã‚’è¦‹ã¤ã‘ã‚‹åŠ›ã€‚</li>
                        <li><span class="font-bold">ã‚ãªãŸæ„Ÿ:</span> ã€Œã“ã‚Œã¯è‡ªåˆ†ã®ãŸã‚ã ã€ã¨æ„Ÿã˜ã‚‹<span class="highlight">å¿ƒã®ç´ç·šã«è§¦ã‚Œã‚‹ã‚‚ã®</span>ã‚’å¤§åˆ‡ã«ã™ã‚‹æ„Ÿæ€§ã€‚</li>
                        <li><span class="font-bold">ã˜ã¶ã‚“QUEST:</span> è‡ªå·±ç†è§£ã‚’æ·±ã‚ã€<span class="highlight">è‡ªåˆ†ã‚’æ´»ã‹ã™æ¢æ±‚</span>ã‚’æ¥½ã—ã‚€å§¿å‹¢ã€‚</li>
                    </ul>
                     <p class="mt-3 text-xs text-gray-600">ã“ã‚Œã‚‰ã®ä¾¡å€¤è¦³ã¯ã€GADHAç†è«–ã‚’<span class="highlight">è‡ªåˆ†äº‹ã¨ã—ã¦æ‰ãˆ</span>ã€ä¸»ä½“çš„ã«å­¦ã¶ä¸Šã§å¤§ããªåŠ©ã‘ã«ãªã‚Šã¾ã™ã€‚</p>
                </div>
                 <div class="pq-card">
                    <h3 class="pq-card-title">ã‚±ã‚¢ã£ã¡ã‹ã‚‰ã®å¿œæ´ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h3>
                    <p class="text-sm text-gray-700">ã‚ãªãŸã®ã€Œå†…çœã€ã¨ã€Œå­¦ç¿’æ¬²ã€ã¯ã€GADHAç†è«–ã®æ·±ã„ç†è§£ã«ç¹‹ãŒã‚Šã¾ã™ã€‚ã€Œåé›†å¿ƒã€ã§å¾—ãŸçŸ¥è­˜ã‚’ã€ã€Œç€æƒ³ã€ã§æ–°ã—ã„ã‚±ã‚¢ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã«å¤‰ãˆã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€Œé‹å‘½æ€è€ƒã€ã§äººã¨ã®ç¹‹ãŒã‚Šã‚’æ„Ÿã˜ã€ã€Œå€‹åˆ¥åŒ–ã€ã§ä¸€äººã²ã¨ã‚Šã«åˆã£ãŸã‚±ã‚¢ã‚’è€ƒãˆã€ã€Œè¦ªå¯†æ€§ã€ã€Œå…±æ„Ÿæ€§ã€ã§å¿ƒã«å¯„ã‚Šæ·»ã„ã€ã€Œæˆé•·ä¿ƒé€²ã€ã§è‡ªä»–ã®å¤‰å®¹ã‚’å–œã³åˆãˆã‚‹ã¯ãšã§ã™ã€‚<br>ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§ã€<span class="highlight">ã€Œã˜ã¶ã‚“QUESTã€</span>ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã­ï¼ã‚±ã‚¢ã£ã¡ãŒã„ã¤ã‚‚å¿œæ´ã—ã¦ã„ã¾ã™ï¼</p>
                </div>`
        };
        let diaryEntries = []; 
        let currentOpenSection = { chapterKey: null, sectionId: null, title: null }; 
        let currentDiaryEntryForDiscussion = null; 

        let db, auth, userId, app;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'gadha-quest-default';

        async function initializeFirebase() {
            showLoading("FirebaseåˆæœŸåŒ–ä¸­...");
            try {
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
                 if (!firebaseConfig.apiKey) {
                    console.error("Firebase è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™ã€‚");
                    setLogLevel('silent'); 
                    initializeAppLocally(); 
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await loadPlayerStateFromFirestore();
                        await loadDiaryEntriesFromFirestore();
                        initializeAppUI();
                    } else {
                         if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            try { await signInWithCustomToken(auth, __initial_auth_token); } catch (error) { await signInAnonymously(auth); }
                        } else { await signInAnonymously(auth); }
                    }
                });
            } catch (error) { initializeAppLocally(); } finally { hideLoading(); }
        }
        
        function initializeAppLocally() {
            console.warn("ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§ã‚¢ãƒ—ãƒªã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚");
            userId = `local-${crypto.randomUUID()}`;
            initializeAppUI(); hideLoading();
        }

        async function savePlayerStateToFirestore() {
            if (!db || !userId) return;
            try {
                await setDoc(doc(db, "artifacts", appId, "users", userId, "playerState", "main"), playerState);
            } catch (error) { console.error("Error saving player state: ", error); }
        }

        async function loadPlayerStateFromFirestore() {
            if (!db || !userId) return;
            try {
                const docSnap = await getDoc(doc(db, "artifacts", appId, "users", userId, "playerState", "main"));
                if (docSnap.exists()) { 
                    const loadedData = docSnap.data();
                    playerState = { 
                        ...playerState, 
                        ...loadedData,
                        customInfoText: loadedData.customInfoText || playerState.customInfoText 
                    }; 
                } 
                else { await savePlayerStateToFirestore(); }
            } catch (error) { console.error("Error loading player state: ", error); }
        }

        async function saveDiaryEntryToFirestore(entry) {
            if (!db || !userId) return null;
            try {
                const docRef = await addDoc(collection(db, "artifacts", appId, "users", userId, "diaryEntries"), { ...entry, createdAt: serverTimestamp() });
                return docRef.id;
            } catch (error) { console.error("Error saving diary entry: ", error); return null; }
        }

        async function loadDiaryEntriesFromFirestore() {
            if (!db || !userId) { diaryEntries = []; return; }
            try {
                const q = query(collection(db, "artifacts", appId, "users", userId, "diaryEntries"), orderBy("date", "desc"));
                const querySnapshot = await getDocs(q);
                diaryEntries = [];
                querySnapshot.forEach((doc) => diaryEntries.push({ id: doc.id, ...doc.data() }));
            } catch (error) { console.error("Error loading diary entries: ", error); diaryEntries = []; }
        }
        
        window.navigateTo = function(screenId, context = null) { 
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            const navButton = document.querySelector(`.nav-button[onclick*="'${screenId}'"]`); 
            if (navButton) navButton.classList.add('active');
            
            const adviceAreaId = `caretchi${screenId.charAt(0).toUpperCase() + screenId.slice(1).replace('Screen','')}Advice`;
            const adviceElem = document.getElementById(adviceAreaId);
            if (adviceElem) {
                let adviceText = "";
                switch(screenId) {
                    case 'homeScreen': 
                        adviceText = playerState.todayActionGoalHint && playerState.todayActionGoalHint !== "ãƒ’ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" && playerState.todayActionGoalHint !== "ã¾ãšã¯GADHAç†è«–ã®åŸºæœ¬ã‚’å¾©ç¿’ã—ã¦ã¿ã‚ˆã†ï¼" && playerState.todayActionGoalHint !== "è¡Œå‹•ã‚’å¤‰ãˆã‚‹å‹‡æ°—ã‚’æŒã£ã¦ã¿ã‚ˆã†ï¼"
                            ? `ã‚±ã‚¢ã£ã¡ã€Œä»Šæ—¥ã®ç›®æ¨™<span class="highlight">${playerState.todayActionGoal.substring(0,10)}...</span>ã®ãƒ’ãƒ³ãƒˆã ã‚ˆï¼ã€` 
                            : "ã‚±ã‚¢ã£ã¡ã€Œä»Šæ—¥ã®ç›®æ¨™ã€ä¸€ç·’ã«é ‘å¼µã‚ã†ã­ï¼ã€"; 
                        break;
                    case 'libraryScreen': adviceText = "ã‚±ã‚¢ã£ã¡ã€ŒçŸ¥ã‚ŠãŸã„ã“ã¨ã€ä½•ã§ã‚‚èã„ã¦ã­ï¼<span class='highlight'>ä¸€ã¤ãšã¤</span>ç¢ºèªã—ã‚ˆã†ã€‚ã€"; break;
                    case 'diaryScreen': adviceText = "ã‚±ã‚¢ã£ã¡ã€Œä»Šæ—¥ã®å‡ºæ¥äº‹ã€<span class='highlight'>ã©ã‚“ãªå°ã•ãªã“ã¨ã§ã‚‚</span>è¨˜éŒ²ã—ã¦ã­ï¼ã€"; break;
                    case 'customInfoScreen': adviceText = "ã‚±ã‚¢ã£ã¡ã€Œã“ã‚Œã¯<span class='highlight'>ã‚ãªãŸã ã‘</span>ã®ç‰¹åˆ¥ãªæƒ…å ±ã ã‚ˆï¼ã€"; break;
                    case 'aiSupportScreen': adviceText = "ã‚±ã‚¢ã£ã¡ã€Œã©ã‚“ãªã“ã¨ã§ã‚‚<span class=\"highlight\">æ°—è»½ã«è©±ã—ã‹ã‘ã¦</span>ã­ï¼ã€"; break;
                }
                adviceElem.innerHTML = adviceText;
            }

            if (screenId === 'homeScreen') updateHomeScreen();
            if (screenId === 'customInfoScreen') displayCustomInfo();
            if (screenId === 'aiSupportScreen' && context) {
                const chatInput = document.getElementById('chatInput');
                const initialMessage = `ã‚±ã‚¢ã£ã¡ã€ã€Œ${context.topic}ã€ã«ã¤ã„ã¦ã‚‚ã£ã¨è©³ã—ãæ•™ãˆã¦ã»ã—ã„ãªã€‚`;
                chatInput.value = ''; 
                addChatMessageToAI("user", initialMessage); 
                addChatMessageToAI("ai", `ã‚‚ã¡ã‚ã‚“ï¼ã€Œ${context.topic}ã€ã«ã¤ã„ã¦ã ã­ã€‚ã©ã‚“ãªã“ã¨ãŒçŸ¥ã‚ŠãŸã„ï¼Ÿ<br>ãƒã‚¤ãƒ³ãƒˆã‚’çµã£ã¦<span class="highlight">ä¸€ã¤ãšã¤</span>èã„ã¦ãã‚Œã‚‹ã¨å¬‰ã—ã„ãªã€‚`);
            } else if (screenId === 'aiSupportScreen') {
                document.getElementById('chatInput').placeholder = "ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ã­";
            }
        }

        window.openModal = function(modalId) { document.getElementById(modalId).style.display = "block"; }
        window.closeModal = function(modalId) { document.getElementById(modalId).style.display = "none"; }

        window.markAsRead = async function() {
            if (currentOpenSection.chapterKey && currentOpenSection.sectionId) {
                const { chapterKey, sectionId } = currentOpenSection;
                gainExp(5);
                playerState.theoryReadSections[sectionId] = true;
                updateTheoryProgress();
                await savePlayerStateToFirestore();
            }
        }
        
        window.discussTheoryWithCaretchi = function() {
            if (currentOpenSection.title) {
                closeModal('theoryModal');
                navigateTo('aiSupportScreen', { topic: `ç†è«–ã€Œ${currentOpenSection.title}ã€` });
            }
        }
        window.discussDiaryWithCaretchi = function() {
            if (currentDiaryEntryForDiscussion) {
                closeModal('logModal');
                navigateTo('aiSupportScreen', { topic: `æ—¥è¨˜ã€Œ${new Date(currentDiaryEntryForDiscussion.date).toLocaleDateString('ja-JP')}ã€ã®æŒ¯ã‚Šè¿”ã‚Š` });
                currentDiaryEntryForDiscussion = null; 
            }
        }
         window.navigateToCaretchiWithCustomInfo = function() {
            navigateTo('aiSupportScreen', { topic: "å°‚ç”¨æƒ…å ±ã«ã¤ã„ã¦" });
        }


        function displayTheory() {
            const theoryContentDiv = document.getElementById('theoryContent');
            theoryContentDiv.innerHTML = '';
            for (const chapterKey in gadhaTheoryData) {
                const chapter = gadhaTheoryData[chapterKey];
                const chapterDiv = document.createElement('div');
                chapterDiv.className = 'pq-card mb-4';
                chapterDiv.innerHTML = `<h3 class="pq-card-title text-lg">${chapter.title}</h3><p class="theory-section-summary mb-2">${chapter.summary}</p>`;
                chapter.sections.forEach(section => {
                    const sectionCard = document.createElement('div');
                    sectionCard.className = 'theory-section p-3 border-l-4 border-green-500 bg-green-100 mb-2 shadow-md rounded-lg'; 
                    sectionCard.innerHTML = `
                        <h4 class="font-bold pixel-font text-md text-green-700">${section.title}</h4>
                        <p class="text-xs text-gray-700 font-medium">${section.content.substring(0, 100).replace(/<span class='highlight'>|<\/span>|<br>/g, " ")}...</p>
                        <button class="pq-button primary text-xs mt-2 py-1 px-2" onclick="showSectionDetail('${chapterKey}', '${section.id}')">è©³ã—ãèª­ã‚€</button>`; 
                    chapterDiv.appendChild(sectionCard);
                });
                theoryContentDiv.appendChild(chapterDiv);
            }
        }

        window.showSectionDetail = function(chapterKey, sectionId) {
            const section = gadhaTheoryData[chapterKey].sections.find(s => s.id === sectionId);
            if (section) {
                currentOpenSection = { chapterKey, sectionId, title: section.title }; 
                document.getElementById('modalTitle').innerHTML = section.title;
                let formattedContent = section.content.split(/<br\s*\/?>\s*<br\s*\/?>/) 
                                          .map(p => p.trim())
                                          .filter(p => p.length > 0)
                                          .map(pText => `<p class="mb-3 text-gray-800">${pText.replace(/\n|<br\s*\/?>/g, ' ')}</p>`).join(''); 
                document.getElementById('modalBody').innerHTML = formattedContent;
                openModal('theoryModal');
            }
        }
        
        document.getElementById('practiceLogForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            showLoading("æ—¥è¨˜ã‚’è¨˜éŒ²ï¼†è©•ä¾¡ä¸­...");
            const diaryText = document.getElementById('diaryEntry').value;
            const newEntryData = {
                date: document.getElementById('diaryDate').value,
                entry: diaryText,
                strength: "", // AI will determine this
                evaluation: "", 
            };

            const combinedPrompt = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ—¥è¨˜ã§ã™ã€‚
[æ—¥è¨˜ã“ã“ã‹ã‚‰]
${diaryText}
[æ—¥è¨˜ã“ã“ã¾ã§]

ã“ã®æ—¥è¨˜ã‚’GADHAç†è«–ã®è¦³ç‚¹ã‹ã‚‰è©•ä¾¡ã—ã€100å­—ä»¥å†…ã§ç°¡æ½”ã«ãƒã‚¸ãƒ†ã‚£ãƒ–ãªç‚¹ã¨æ”¹å–„ç‚¹ã‚’æŒ‡æ‘˜ã—ã¦ãã ã•ã„ã€‚
ã¾ãŸã€ã“ã®æ—¥è¨˜ã®å†…å®¹ã‹ã‚‰ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ´»ã‹ã›ãŸã¨æ€ã‚ã‚Œã‚‹ã‚¹ãƒˆãƒ¬ãƒ³ã‚°ã‚¹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ã®è³‡è³ªï¼ˆ${userStrengthsFull.join("ã€")}ã®ä¸­ã‹ã‚‰æœ€ã‚‚é©åˆ‡ãªã‚‚ã®ã‚’1ã¤ã ã‘ï¼‰ã‚’æŒ™ã’ã¦ãã ã•ã„ã€‚
æœ€å¾Œã«ã€ã“ã®æ—¥è¨˜ã¨è©•ä¾¡ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç‰¹æ€§ï¼ˆä¸Šä½è³‡è³ª: ${userTopStrengths.join(", ")}ã€WMIä½ï¼‰ã‚’è¸ã¾ãˆã€æ¬¡ã®å…·ä½“çš„ã§å°ã•ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç›®æ¨™ã‚’1ã¤ã€30å­—ä»¥å†…ã§ææ¡ˆã—ã¦ãã ã•ã„ã€‚
ã•ã‚‰ã«ã€ãã®ææ¡ˆã—ãŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ç›®æ¨™ã‚’é”æˆã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—ã‚„ãƒ’ãƒ³ãƒˆã‚’ã€ç®‡æ¡æ›¸ãã§3ã¤ã€å„ãƒ’ãƒ³ãƒˆã¯çŸ­ãææ¡ˆã—ã¦ãã ã•ã„ã€‚

å›ç­”å½¢å¼ã¯ä»¥ä¸‹ã®JSONã§ãŠé¡˜ã„ã—ã¾ã™:
{
  "evaluation": "ï¼ˆè©•ä¾¡æ–‡ï¼‰",
  "usedStrength": "ï¼ˆæ´»ã‹ã›ãŸè³‡è³ªåã€ãªã‘ã‚Œã°ã€Œç‰¹ã«ãªã—ã€ï¼‰",
  "nextActionGoal": "ï¼ˆç¿Œæ—¥ã®ç›®æ¨™ï¼‰",
  "goalHints": ["ãƒ»ãƒ’ãƒ³ãƒˆ1", "ãƒ»ãƒ’ãƒ³ãƒˆ2", "ãƒ»ãƒ’ãƒ³ãƒˆ3"]
}`;
            
            try {
                const aiResponse = await callGeminiAPI(combinedPrompt, true); // Pass true for JSON response
                if (aiResponse) {
                    newEntryData.evaluation = aiResponse.evaluation || "è©•ä¾¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                    newEntryData.strength = aiResponse.usedStrength || "ç‰¹ã«ãªã—";
                    playerState.todayActionGoal = aiResponse.nextActionGoal || "AIç›®æ¨™å–å¾—å¤±æ•—ã€‚è‡ªåˆ†ã§è¨­å®šã—ã‚ˆã†ï¼";
                    playerState.todayActionGoalHint = aiResponse.goalHints ? aiResponse.goalHints.join('\n') : "ãƒ’ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";

                    document.getElementById('evaluationText').innerHTML = newEntryData.evaluation.replace(/\n/g, '<br>');
                    document.getElementById('evaluatedStrengthText').textContent = newEntryData.strength;
                    document.getElementById('lastDiaryEvaluation').style.display = 'block';
                } else {
                    throw new Error("AI response was null or undefined");
                }
            } catch (error) {
                console.error("Error processing diary with AI:", error);
                newEntryData.evaluation = "è©•ä¾¡ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                newEntryData.strength = "ä¸æ˜";
                playerState.todayActionGoal = "ã€Œå¤‰å®¹ç·¨ã€ã®ãƒã‚¤ãƒ³ãƒˆã‚’ä¸€ã¤å®Ÿè·µã—ã‚ˆã†ã€‚"; 
                playerState.todayActionGoalHint = "è¡Œå‹•ã‚’å¤‰ãˆã‚‹å‹‡æ°—ã‚’æŒã£ã¦ã¿ã‚ˆã†ï¼";
                document.getElementById('evaluationText').textContent = newEntryData.evaluation;
                document.getElementById('evaluatedStrengthText').textContent = newEntryData.strength;
                document.getElementById('lastDiaryEvaluation').style.display = 'block';
            }
            
            const firestoreId = await saveDiaryEntryToFirestore(newEntryData); 
            const newEntry = { id: firestoreId || Date.now().toString(), ...newEntryData };
            diaryEntries.unshift(newEntry);
            diaryEntries.sort((a, b) => new Date(b.date) - new Date(a.date));
            displayDiaryLogs(); 
            
            this.reset();
            document.getElementById('diaryDate').valueAsDate = new Date();
            gainExp(20); playerState.careCrystals += 5;
            
            await savePlayerStateToFirestore();
            updateHomeScreen();
            addChatMessageToAI("ai", `æ—¥è¨˜ã€èª­ã‚“ã ã‚ˆï¼è©•ä¾¡ã¨æ´»ã‹ã›ãŸåŠ›ã‚‚åˆ†æã—ã¦ã¿ãŸã‹ã‚‰ç¢ºèªã—ã¦ã­ã€‚æ˜æ—¥ã®ç›®æ¨™ã‚‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¨­å®šã—ãŸã‚ˆï¼`);
            hideLoading();
        });

        function displayDiaryLogs(filteredEntries = null) {
            const logListDiv = document.getElementById('diaryLogList');
            logListDiv.innerHTML = '';
            const entriesToDisplay = filteredEntries || diaryEntries;
            if (entriesToDisplay.length === 0) {
                logListDiv.innerHTML += '<p class="small-text text-gray-500 text-center">ã¾ã æ—¥è¨˜ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>'; return;
            }
            entriesToDisplay.forEach(log => {
                const logDiv = document.createElement('div');
                logDiv.className = 'pq-card mb-2 p-3';
                logDiv.innerHTML = `
                    <h4 class="pq-card-title text-base">${new Date(log.date).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })} ${log.strength && log.strength !== "ç‰¹ã«ãªã—" ? `<span class="text-xs highlight">${log.strength}</span>` : ''}</h4>
                    <p class="small-text text-gray-600">${log.entry.substring(0,120)}...</p>
                    ${log.evaluation ? `<div class="mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded-md text-xs text-yellow-700"><strong class="pixel-font">ã‚±ã‚¢ã£ã¡è©•ä¾¡:</strong> ${log.evaluation.substring(0,80)}...</div>` : ''}
                    <button class="pq-button accent text-xs mt-1 py-1 px-2" onclick="viewDiaryDetail('${log.id}')">è©³ç´°ã¨è©•ä¾¡</button>`;
                logListDiv.appendChild(logDiv);
            });
        }
        
        window.searchDiary = function() {
            const keyword = document.getElementById('diarySearchKeyword').value.toLowerCase();
            if (!keyword) { displayDiaryLogs(); return; }
            const filtered = diaryEntries.filter(log => 
                log.entry.toLowerCase().includes(keyword) || 
                (log.strength && log.strength.toLowerCase().includes(keyword)) ||
                (log.evaluation && log.evaluation.toLowerCase().includes(keyword)) ||
                new Date(log.date).toLocaleDateString('ja-JP').includes(keyword)
            );
            displayDiaryLogs(filtered);
        }

        window.viewDiaryDetail = function(logId) {
            const log = diaryEntries.find(l => String(l.id) === String(logId));
            if (log) {
                currentDiaryEntryForDiscussion = log; 
                document.getElementById('logModalTitle').innerHTML = `${new Date(log.date).toLocaleDateString('ja-JP')} ã®æ—¥è¨˜`;
                let bodyContent = `<p class="whitespace-pre-wrap">${log.entry}</p>`;
                if (log.strength && log.strength !== "ç‰¹ã«ãªã—") bodyContent += `<p class="mt-2"><strong>ã‚±ã‚¢ã£ã¡ãŒè¦‹ã¤ã‘ãŸåŠ›ï¼š</strong> <span class="highlight">${log.strength}</span></p>`;
                if (log.evaluation) {
                     bodyContent += `<div class="mt-3 diary-evaluation"><h3 class="pixel-font">ã‚±ã‚¢ã£ã¡ã®è©•ä¾¡</h3><p>${log.evaluation.replace(/\n/g, '<br>')}</p></div>`;
                }
                document.getElementById('logModalBody').innerHTML = bodyContent;
                openModal('logModal');
            } else { alert("æŒ‡å®šã•ã‚ŒãŸæ—¥è¨˜ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"); }
        }
        
        function updateHomeScreen() {
            document.getElementById('todayActionGoal').innerHTML = playerState.todayActionGoal || "ã‚±ã‚¢ã£ã¡ã‹ã‚‰ã®ç›®æ¨™ã‚’ãŠæ¥½ã—ã¿ã«ï¼";
            const hintListElem = document.getElementById('actionGoalHintList');
            const hintContainer = document.getElementById('todayActionGoalHint');
            if (playerState.todayActionGoalHint && playerState.todayActionGoalHint !== "ãƒ’ãƒ³ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚" && playerState.todayActionGoalHint !== "ã¾ãšã¯GADHAç†è«–ã®åŸºæœ¬ã‚’å¾©ç¿’ã—ã¦ã¿ã‚ˆã†ï¼" && playerState.todayActionGoalHint !== "è¡Œå‹•ã‚’å¤‰ãˆã‚‹å‹‡æ°—ã‚’æŒã£ã¦ã¿ã‚ˆã†ï¼") {
                hintListElem.innerHTML = playerState.todayActionGoalHint.split('\n').map(hint => `<li>${hint.replace(/^- /,'')}</li>`).join('');
                hintContainer.style.display = 'none'; 
            } else {
                hintListElem.innerHTML = '<li>å…·ä½“çš„ãªãƒ’ãƒ³ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªåˆ†ã§è€ƒãˆã¦ã¿ã‚ˆã†ï¼</li>';
                hintContainer.style.display = 'none';
            }

            updateStatus(); updateTheoryProgress(); updatePracticeCount();
            const totalSections = Object.values(gadhaTheoryData).reduce((sum, chapter) => sum + chapter.sections.reduce((s, sec) => s + 1, 0), 0);
            const readCount = Object.keys(playerState.theoryReadSections).length;
            const theoryProgressVal = totalSections > 0 ? Math.round((readCount / totalSections) * 100) : 0;
            const practiceTarget = 30;
            const practiceProgressVal = Math.min(100, Math.round((diaryEntries.length / practiceTarget) * 100));
            const overallProgressVal = Math.round((theoryProgressVal + practiceProgressVal) / 2);
            const overallProgressElem = document.getElementById('overallProgress');
            overallProgressElem.style.width = `${overallProgressVal}%`;
            overallProgressElem.textContent = `${overallProgressVal}%`;
        }
        
        window.toggleActionGoalHint = function() {
            const hintContainer = document.getElementById('todayActionGoalHint');
            hintContainer.style.display = hintContainer.style.display === 'none' ? 'block' : 'none';
        }


        function updateTheoryProgress() {
            const totalSections = Object.values(gadhaTheoryData).reduce((sum, chapter) => sum + chapter.sections.reduce((s, sec) => s + 1, 0), 0);
            const readCount = Object.keys(playerState.theoryReadSections).length;
            document.getElementById('theoryProgress').textContent = totalSections > 0 ? `${Math.round((readCount / totalSections) * 100)}` : '0';
        }
        function updatePracticeCount() { document.getElementById('practiceCount').textContent = diaryEntries.length; }

        function displayCustomInfo() {
            document.getElementById('customInfoContent').innerHTML = playerState.customInfoText;
        }
        
        window.updateCustomInfoWithAI = async function() {
            showLoading("å°‚ç”¨æƒ…å ±ã‚’AIãŒæ›´æ–°ä¸­...");
            const theoryProg = playerState.theoryReadSections ? (Object.keys(playerState.theoryReadSections).length / Object.values(gadhaTheoryData).reduce((s,c)=>s+c.sections.length,0)*100).toFixed(0) : 0;
            const prompt = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®GADHAç†è«–ä½“å¾—ã‚’æ”¯æ´ã™ã‚‹ã€Œã‚ãªãŸå°‚ç”¨æƒ…å ±ã€ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±:
- ã‚¹ãƒˆãƒ¬ãƒ³ã‚°ã‚¹ãƒ•ã‚¡ã‚¤ãƒ³ãƒ€ãƒ¼ä¸Šä½è³‡è³ª: ${userStrengthsFull.join("ã€")}
- WAIS-IV WMI(ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒª): 82 (ä½ã„å‚¾å‘)
- å¤§åˆ‡ã«ã—ã¦ã„ã‚‹ä¾¡å€¤è¦³: ã€Œä¾¡å€¤ã‚ã‚‹é¸æŠè‚¢ã®å‰µé€ ã€ã€Œã‚ãªãŸæ„Ÿã€ã€Œã˜ã¶ã‚“QUESTã€
- ASDå½“äº‹è€…ã§ã‚ã‚Šã€è‡ªå·±ç†è§£ã‚’æ·±ã‚ã¦ã„ã‚‹ã€‚
ç¾åœ¨ã®é€²æ—:
- GADHAç†è«–ã®ç†è§£åº¦: ${theoryProg}%
- å®Ÿè·µæ—¥è¨˜ã®è¨˜éŒ²å›æ•°: ${diaryEntries.length}ä»¶
æŒ‡ç¤º:
ä¸Šè¨˜æƒ…å ±ã‚’æœ€å¤§é™ã«æ´»ç”¨ã—ã€å…·ä½“çš„ã§ãƒ‘ãƒ¼ã‚½ãƒŠãƒ«ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’HTMLå½¢å¼ã§ã€è¤‡æ•°ã®ã‚«ãƒ¼ãƒ‰(.pq-card)ã¨ã—ã¦ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚å„ã‚«ãƒ¼ãƒ‰ã«ã¯<h3 class="pq-card-title">ã‚¿ã‚¤ãƒˆãƒ«</h3>ã¨<p class="text-sm text-gray-700">æœ¬æ–‡</p>ã‚’å«ã‚ã¾ã™ã€‚æƒ…å ±é‡ã‚’æœ€å¤§é™ã«å¢—ã‚„ã—ã€èª­ã¿ã‚„ã™ãã€ã‹ã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç‰¹æ€§ï¼ˆç‰¹ã«WMIã®ä½ã•ã€å¼·ã¿ã€ä¾¡å€¤è¦³ã€å®¶æ—çŠ¶æ³ï¼‰ã«æ·±ãå¯„ã‚Šæ·»ã£ãŸå†…å®¹ã«ã—ã¦ãã ã•ã„ã€‚é‡è¦ãªç®‡æ‰€ã¯<span class="highlight"></span>ã§å¼·èª¿ã—ã€è¿”ç­”ã¯æ˜ç­ã‹ã¤ç°¡æ½”ã«ã€‚`;
            try {
                const newCustomInfo = await callGeminiAPI(prompt);
                if (newCustomInfo) {
                    playerState.customInfoText = newCustomInfo; 
                    playerState.customInfoLastUpdate = new Date().toISOString();
                    displayCustomInfo(); await savePlayerStateToFirestore();
                    addChatMessageToAI("ai", "ã‚±ã‚¢ã£ã¡ã ã‚ˆï¼ã‚ãªãŸå°‚ç”¨æƒ…å ±ã‚’æ–°ã—ãã—ãŸã‹ã‚‰ã€è¦‹ã¦ã¿ã¦ã­ï¼");
                } else { addChatMessageToAI("ai", "ã†ãƒ¼ã‚“ã€å°‚ç”¨æƒ…å ±ã®æ›´æ–°ã€ã†ã¾ãã„ã‹ãªã‹ã£ãŸã¿ãŸã„ã€‚ã‚‚ã†ä¸€å›è©¦ã—ã¦ã¿ã¦ãã‚Œã‚‹ï¼Ÿ"); }
            } catch (error) { addChatMessageToAI("ai", "å°‚ç”¨æƒ…å ±ã®æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒèµ·ãã¡ã‚ƒã£ãŸã€‚ã”ã‚ã‚“ã­ã€‚"); }
             finally { hideLoading(); }
        }

        window.askCaretchiFromLibrary = async function() { 
            const query = document.getElementById('libraryQuery').value;
            const responseArea = document.getElementById('libraryAiResponse');
            if (!query.trim()) { responseArea.innerHTML = `<p class="text-red-500 text-sm">è³ªå•ã‚’æ›¸ã„ã¦ã­ã€‚</p>`; responseArea.style.display = 'block'; return; }
            showLoading("ã‚±ã‚¢ã£ã¡ãŒè€ƒãˆä¸­...");
            const prompt = `GADHAç†è«–ã®è³ªå•ã€Œ${query}ã€ã«ã¤ã„ã¦ã€åˆ†ã‹ã‚Šã‚„ã™ãæ•™ãˆã¦ã€‚ãƒã‚¤ãƒ³ãƒˆã¯<span class="highlight">å¼·èª¿</span>ã—ã¦ã­ã€‚çŸ­ãã€å¤§åˆ‡ãªã“ã¨ã ã‘ã§OKã ã‚ˆã€‚`;
            try {
                const aiResponse = await callGeminiAPI(prompt);
                responseArea.innerHTML = `<h3 class="pixel-font">ã‚±ã‚¢ã£ã¡ã‚ˆã‚Š</h3><p>${aiResponse || "ã¡ã‚‡ã£ã¨é›£ã—ã„è³ªå•ã ã£ãŸã‹ãªï¼Ÿåˆ¥ã®è¨€è‘‰ã§èã„ã¦ã¿ã¦ï¼"}</p>`;
                responseArea.style.display = 'block';
            } catch (error) { responseArea.innerHTML = `<h3 class="pixel-font">ã‚±ã‚¢ã£ã¡ã‚ˆã‚Š</h3><p>ã”ã‚ã‚“ï¼ã‚¨ãƒ©ãƒ¼ã ã‚ˆã€‚ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã­ã€‚</p>`; responseArea.style.display = 'block';}
            finally { document.getElementById('libraryQuery').value = ''; hideLoading(); }
        }

        window.sendChatMessage = async function() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;
            addChatMessageToAI("user", message); input.value = ''; showLoading("ã‚±ã‚¢ã£ã¡ãŒè¿”ä¿¡ä¸­...");
            const prompt = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒãƒ£ãƒƒãƒˆã€Œ${message}ã€ã¸ã®è¿”ä¿¡ã‚’è€ƒãˆã¦ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯GADHAç†è«–ã‚’å­¦ã‚“ã§ã„ã¦ã€ãƒ¯ãƒ¼ã‚­ãƒ³ã‚°ãƒ¡ãƒ¢ãƒªãŒä½ã‚ã ã‹ã‚‰ã€<span class="highlight">çŸ­ãã€åˆ†ã‹ã‚Šã‚„ã™ã„è¨€è‘‰</span>ã§ç­”ãˆã¦ã­ã€‚ã‚‚ã—å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ææ¡ˆã§ãã‚‹ãªã‚‰ã€ã€Œä»Šæ—¥ã®ç›®æ¨™ã«ã©ã†ã‹ãªï¼Ÿã€ã¨èã„ã¦ã¿ã¦ã€‚`;
            try {
                const aiResponseText = await callGeminiAPI(prompt);
                addChatMessageToAI("ai", aiResponseText || "ã”ã‚ã‚“ã­ã€ã†ã¾ãè¨€è‘‰ãŒå‡ºã¦ã“ãªã„ã‚„ã€‚");
                if (aiResponseText.toLowerCase().includes("ç›®æ¨™ã«ã©ã†ã‹ãªï¼Ÿ") || aiResponseText.toLowerCase().includes("è©¦ã—ã¦ã¿ã‚ˆã†")) { 
                    const potentialGoalMatch = aiResponseText.match(/ã€Œ(.*?)ã€ã‚’ç›®æ¨™ã«ã©ã†ã‹ãªï¼Ÿ|ã€Œ(.*?)ã€ã‚’è©¦ã—ã¦ã¿ã‚ˆã†/);
                    const potentialGoal = potentialGoalMatch ? (potentialGoalMatch[1] || potentialGoalMatch[2]) : null;
                    if (potentialGoal && potentialGoal.length < 100) {
                        document.getElementById('suggestedActionText').textContent = potentialGoal;
                        document.getElementById('actionableResponseArea').style.display = 'block';
                    } else { document.getElementById('actionableResponseArea').style.display = 'none';}
                } else { document.getElementById('actionableResponseArea').style.display = 'none'; }
            } catch (error) { addChatMessageToAI("ai", "é€šä¿¡ã‚¨ãƒ©ãƒ¼ã ã‚ˆã€‚ã”ã‚ã‚“ã­ã€‚"); }
            finally { hideLoading(); }
        }
        
        function addChatMessageToAI(sender, message) {
            const chatArea = document.getElementById('chatArea');
            const bubble = document.createElement('div');
            bubble.classList.add('chat-bubble', sender); bubble.innerHTML = message;
            chatArea.appendChild(bubble); chatArea.scrollTop = chatArea.scrollHeight;
        }

        window.adoptAsActionGoal = async function() {
            const suggestedAction = document.getElementById('suggestedActionText').textContent;
            if (suggestedAction) {
                playerState.todayActionGoal = suggestedAction; 
                const hintPrompt = `ç›®æ¨™ã€Œ${suggestedAction}ã€ã‚’é”æˆã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªã‚¹ãƒ†ãƒƒãƒ—ã‚„ãƒ’ãƒ³ãƒˆã‚’ã€ç®‡æ¡æ›¸ãã§3ã¤ææ¡ˆã—ã¦ã€‚å„ãƒ’ãƒ³ãƒˆã¯çŸ­ãã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®WMIã®ä½ã•ã«é…æ…®ã—ã¦ã€‚`;
                try {
                    playerState.todayActionGoalHint = await callGeminiAPI(hintPrompt) || "å…·ä½“çš„ãªãƒ’ãƒ³ãƒˆã¯ã¾ãŸä»Šåº¦ã­ï¼";
                } catch (error) {
                    playerState.todayActionGoalHint = "ã¾ãšã¯ç›®æ¨™ã‚’æ„è­˜ã™ã‚‹ã“ã¨ã‹ã‚‰å§‹ã‚ã¦ã¿ã‚ˆã†ï¼";
                }
                updateHomeScreen(); navigateTo('homeScreen');
                addChatMessageToAI("ai", `ã‚ˆã—ï¼ã€Œ${suggestedAction}ã€ã‚’ä»Šæ—¥ã®ç›®æ¨™ã«ã—ãŸã‚ˆï¼å¿œæ´ã—ã¦ã‚‹ï¼`);
                document.getElementById('actionableResponseArea').style.display = 'none';
                await savePlayerStateToFirestore();
            }
        }

        async function gainExp(amount) {
            playerState.exp += amount;
            if (playerState.exp >= (playerState.level * 50) && playerState.level < 10) {
                playerState.level++;
                addChatMessageToAI("ai", `ã‚„ã£ãŸã­ï¼ãƒ¬ãƒ™ãƒ«ãŒ<span class="highlight">${playerState.level}</span>ã«ãªã£ãŸã‚ˆï¼`);
            }
            updateStatus(); await savePlayerStateToFirestore();
        }

        function updateStatus() {
            document.getElementById('playerLevel').textContent = playerState.level;
            document.getElementById('playerExp').textContent = playerState.exp;
            document.getElementById('playerCareCrystals').textContent = playerState.careCrystals;
        }
        
        async function callGeminiAPI(promptText, expectJson = false) {
            showLoading("AIã¨é€šä¿¡ä¸­...");
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_TEXT_MODEL}:generateContent?key=${apiKey}`;
            
            const payload = { 
                contents: [{ role: "user", parts: [{ text: promptText }] }], 
                generationConfig: { 
                    temperature: 0.6, 
                    maxOutputTokens: 800, 
                    ...(expectJson && { responseMimeType: "application/json"}), // Add this if expecting JSON
                    "safetySettings": [
                        {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
                        {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
                        {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"},
                        {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_MEDIUM_AND_ABOVE"}
                    ]
                }
            }; 
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { 
                    const errorBody = await response.json(); 
                    console.error("Gemini API Error:", response.status, errorBody);
                    let errorMessage = `APIãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•— ${response.status}`;
                    if (errorBody && errorBody.error && errorBody.error.message) {
                        errorMessage += `: ${errorBody.error.message}`;
                    }
                    throw new Error(errorMessage); 
                }
                const result = await response.json();
                if (result.candidates && result.candidates[0]?.content?.parts?.[0]?.text) {
                    hideLoading();
                    if (expectJson) {
                        try {
                            // The response text might be wrapped in markdown ```json ... ```
                            const jsonText = result.candidates[0].content.parts[0].text.replace(/^```json\s*|```\s*$/g, '');
                            return JSON.parse(jsonText);
                        } catch (e) {
                            console.error("Error parsing JSON from AI response:", e, result.candidates[0].content.parts[0].text);
                            return null; // Or throw error
                        }
                    }
                    return result.candidates[0].content.parts[0].text;
                } else if (result.candidates && result.candidates[0]?.finishReason === "SAFETY") {
                    hideLoading(); return "ã‚±ã‚¢ã£ã¡ï¼šå®‰å…¨ä¸Šã®ç†ç”±ã§ã€ã“ã®ãŠè©±ã¯ç¶šã‘ã‚‰ã‚Œãªã„ã¿ãŸã„ã€‚ã”ã‚ã‚“ã­ã€‚";
                }
                 else { 
                    console.error("Gemini API - Unexpected response structure:", result);
                    hideLoading(); return "AIå¿œç­”å½¢å¼ã‚¨ãƒ©ãƒ¼ã€‚"; 
                }
            } catch (error) { console.error("Gemini API Error:", error); hideLoading(); throw error; }
        }

        function showLoading(message = "å‡¦ç†ä¸­...") {
            const indicator = document.getElementById('loadingIndicator');
            indicator.querySelector('div').textContent = message; indicator.style.display = 'flex';
        }
        function hideLoading() { document.getElementById('loadingIndicator').style.display = 'none'; }
        
        async function initializeAppUI() {
            // const strengthSelectDiary = document.getElementById('usedStrengthDiary'); // This element is removed
            // strengthSelectDiary.innerHTML = '<option value="">ãªã—</option>';
            // userStrengthsFull.forEach(strength => {
            //     const option = document.createElement('option');
            //     option.value = strength; option.textContent = strength;
            //     strengthSelectDiary.appendChild(option);
            // });
            document.getElementById('diaryDate').valueAsDate = new Date();
            displayTheory(); displayDiaryLogs(); displayCustomInfo(); updateHomeScreen(); navigateTo('homeScreen');
            hideLoading();
        }
        
        window.onclick = function(event) { if (event.target.classList.contains('modal')) closeModal(event.target.id); }
        window.onload = initializeFirebase;
    </script>
</body>
</html>
